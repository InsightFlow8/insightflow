---
title: "Imba_data EDA"
author: "Zhenyu Zhang"
date: "2025-06-13"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(data.table)
library(purrr)
library(skimr)
library(tidyverse)
library(scales)
library(knitr)
library(lubridate)
library(DT)
library(ggplot2)
library(scales)
library(corrplot)
library(lubridate)
```


```{r load locol-data, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
orders                <- read_csv("orders.csv", show_col_types = FALSE)
products              <- read_csv("products.csv", show_col_types = FALSE)
aisles                <- read_csv("aisles.csv", show_col_types = FALSE)
departments           <- read_csv("departments.csv", show_col_types = FALSE)
order_products_prior  <- read_csv("order_products_prior.csv.gz", show_col_types = FALSE)
order_products_train  <- read_csv("order_products_train.csv.gz", show_col_types = FALSE)
```

---
1. raw data pre check
```{r pre_check, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# consistency check Primary key uniqueness check
# prior
order_products_prior %>% 
  summarise(total = n(), 
            distinct_pairs = n_distinct(paste(order_id, product_id, sep = "_")))

# train
order_products_train %>% 
  summarise(total = n(), 
            distinct_pairs = n_distinct(paste(order_id, product_id, sep = "_")))
```
```{r pre_check_2, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# Foreign key integrity check
# prior
order_products_prior %>% anti_join(orders,    by = "order_id")   %>% count()   # åº”ä¸º 0
order_products_prior %>% anti_join(products,  by = "product_id") %>% count()   # åº”ä¸º 0

# train
order_products_train %>% anti_join(orders,    by = "order_id")   %>% count()   # åº”ä¸º 0
order_products_train %>% anti_join(products,  by = "product_id") %>% count()   # åº”ä¸º 0
```


```{r pre_check_3, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# Put all tables into a list
tables <- list(
  orders                 = orders,
  order_products_prior   = order_products_prior,
  order_products_train   = order_products_train,
  products               = products,
  aisles                 = aisles,
  departments            = departments
)

# 1. Total number of missing values in each table
map_int(tables, ~ sum(is.na(.))) %>% 
  enframe(name = "table", value = "n_missing") %>% 
  knitr::kable(caption = "Total number of missing values")

# 2. Missing rate by column in each table
map(tables, ~ map_dbl(., ~ mean(is.na(.)))) %>% 
  map_df(~ .x, .id = "table") %>% 
  pivot_longer(-table, names_to = "column", values_to = "missing_rate") %>% 
  filter(missing_rate > 0) %>% 
  arrange(desc(missing_rate)) %>% 
  knitr::kable(
    caption = "Missing rate by column in each table (only missing columns are listed)",
    digits = 3
  )

```

```{r pre_check_4, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# 3. Calculate the number and rate of missing data for each table and column
missing_detail <- map_df(
  tables,
  ~ tibble(
      column       = names(.x),
      n_missing    = colSums(is.na(.x)),
      missing_rate = colMeans(is.na(.x))
    ),
  .id = "table"
) %>%
  filter(n_missing > 0) %>%
  arrange(table, desc(missing_rate))

missing_detail %>%
  knitr::kable(
    caption = "Detailed Missing Data by Table and Column",
    digits = c(0, 0, 3),
    col.names = c("Table", "Column", "Missing Count", "Missing Rate")
  )

```

```{r pre_check_5, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
orders_cleaned <- orders %>% 
  drop_na(days_since_prior_order)
```




```{r EDA for order table, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# Display the first few rows of the tables
# head(orders)

# Use `spec()` and/or `skimr::skim()` to retrieve the full column specification for this data
spec(orders)
skimr::skim(orders)
spec(products)
spec(aisles)
spec(departments)
spec(order_products_prior)
spec(order_products_train)

```
---

2. Single table EDAï¼ˆExplore Data Analysisï¼‰

2.0 å‡†å¤‡å·¥ä½œ
type conversion [æŠŠç¦»æ•£çš„æ•°å­—åˆ—å˜æˆå› å­æˆ–æ•´æ•°ï¼Œä¾¿äºåç»­ç»˜å›¾ä¸æ±‡æ€»]
```{r type conversion, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
orders <- orders %>% 
  mutate(
    order_dow          = factor(order_dow, levels = 0:6,
                                labels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")),
    order_hour_of_day  = as.integer(order_hour_of_day),
    eval_set           = factor(eval_set, levels = c("prior","train","test"))
  )


orders_cleaned <- orders_cleaned %>% 
  mutate(
    order_dow          = factor(order_dow, levels = 0:6,
                                labels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")),
    order_hour_of_day  = as.integer(order_hour_of_day),
    eval_set           = factor(eval_set, levels = c("prior","train","test"))
  )


order_products_prior <- order_products_prior %>% mutate_all(~ ifelse(is.na(.), ., .))
order_products_train <- order_products_train

products   <- products   %>% mutate(across(c(product_id, aisle_id, department_id), as.integer))
aisles     <- aisles     %>% mutate(aisle_id = as.integer(aisle_id))
departments<- departments%>% mutate(department_id = as.integer(department_id))

```


```{r orders, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
orders %>% 
  summarise(
    total_orders = n(),
    total_users  = n_distinct(user_id)
  )


```


2.1 è®¢å• (orders)
æŒ‰æ˜ŸæœŸ & å°æ—¶åˆ†å¸ƒ
```{r orders distribution, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# Order distribution by day of the week
orders_cleaned %>% 
  count(order_dow) %>% 
  ggplot(aes(order_dow, n)) +
    geom_col() +
    labs(
      title = "Order distribution by day of the week",
      x = NULL, y = "Order Number"
    ) +
    theme_minimal()

# Order distribution by hour
orders_cleaned %>% 
  count(order_hour_of_day) %>% 
  ggplot(aes(order_hour_of_day, n)) +
    geom_col() +
    scale_x_continuous(breaks = seq(0,23,by=2)) +
    labs(
      title = "Order distribution by hour",
      x = "Hour", y = "Order Number"
    ) +
    theme_minimal()

```

å¤è´­å‘¨æœŸåˆ†å¸ƒ
```{r repurchase cycle distribution, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
orders_cleaned %>% 
  filter(!is.na(days_since_prior_order)) %>% 
  ggplot(aes(days_since_prior_order)) +
    geom_histogram(binwidth = 1) +
    scale_x_continuous(limits = c(0, 30)) +    # æˆªå–å‰ä¸¤ä¸ªæœˆæ›´æ¸…æ™°
    labs(
      title = "Distribution of days between repurchases",
      x = "Days since last order", y = "Frequency"
    ) +
    theme_minimal()

```

ç”¨æˆ·ä¸‹å•æ¬¡æ•°åˆ†å¸ƒ
```{r distribution of order times, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
orders_cleaned %>% 
  count(user_id, name = "order_count") %>% 
  ggplot(aes(order_count)) +
    geom_histogram(
      breaks = seq(0, 100, by = 10),
      closed = "right",
      color  = "white"
    ) +
    # linear X axis with 10-unit ticks
    scale_x_continuous(
      breaks = seq(0, 100, by = 10),
      labels = comma_format()
    ) +
    # log10 on Y axis
    scale_y_continuous(
      trans  = "log10",
      labels = comma_format()
    ) +    labs(
      title = "Distribution of Orders Per User",
      x     = "Total Orders per User",
      y     = "Number of Users (log scale)"
    ) +
    theme_minimal()


```


2.2 è®¢å•â€“äº§å“ (order_products)
```{r order_products1, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# åˆå¹¶ç¤ºä¾‹
order_products <- bind_rows(
  order_products_prior  %>% mutate(src = "prior"),
  order_products_train  %>% mutate(src = "train")
)

order_products %>% 
  count(order_id, name="items_per_order") %>% 
  ggplot(aes(items_per_order)) +
    # bins of size 10: [0â€“10),[10â€“20)â€¦ up to 100
    geom_histogram(
      breaks = seq(0,100,by=10), 
      closed = "right", 
      color  = "white"
    ) +
    scale_x_continuous(
      breaks = seq(0,100,by=10),
      labels = seq(0,100,by=10)
    ) +
    scale_y_continuous(
      trans  = "log10",
      labels = scales::comma_format()
    ) +
    labs(
      title = "æ¯ç¬”è®¢å•çš„å•†å“æ•°é‡åˆ†å¸ƒ",
      x     = "å•†å“æ•°é‡",
      y     = "è®¢å•æ•° (log scale)"
    ) +
    theme_minimal()

```

```{r order_products2, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# how often items land in each cart position
order_products %>% 
  count(add_to_cart_order) %>% 
  filter(add_to_cart_order <= 20) %>%   # é™åˆ¶åˆ°å‰20ä¸ªä½ç½®
  ggplot(aes(add_to_cart_order, n)) +
    geom_col() +
    labs(
      title = "åŠ å…¥è´­ç‰©è½¦é¡ºåºåˆ†å¸ƒï¼ˆå‰20ä½ï¼‰",
      x     = "åŠ å…¥é¡ºåº",
      y     = "é¢‘æ¬¡"
    ) +
    theme_minimal()

```


```{r order_products3, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
order_products %>% 
  group_by(product_id) %>% 
  summarise(
    avg_pos = mean(add_to_cart_order),
    count   = n(),
    .groups = "drop"
  ) %>% 
  filter(count >= 1000) %>%    # åªçœ‹é”€é‡å¤Ÿå¤§çš„äº§å“
  slice_min(avg_pos, n = 10) %>% 
  left_join(products, by="product_id") %>% 
  ggplot(aes(fct_reorder(product_name, avg_pos), avg_pos)) +
    geom_col() +
    coord_flip() +
    labs(
      title = "å¹³å‡åŠ å…¥è´­ç‰©è½¦é¡ºåºæœ€é å‰çš„10ç§äº§å“",
      x     = NULL,
      y     = "å¹³å‡åŠ å…¥é¡ºåº"
    ) +
    theme_minimal()


```






```{r order_products4, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# overall spread of reorder_rate across products
order_products %>% 
  group_by(product_id) %>% 
  summarise(
    reorder_rate = mean(reordered),
    sales        = n(),
    .groups      = "drop"
  ) %>% 
  ggplot(aes(reorder_rate)) +
    geom_histogram(bins = 50) +
    labs(
      title = "äº§å“å±‚é¢å¤è´­ç‡åˆ†å¸ƒ",
      x     = "å¤è´­ç‡",
      y     = "äº§å“æ•°"
    ) +
    theme_minimal()

# Top-10 å¤è´­ç‡æœ€é«˜äº§å“
order_products %>% 
  group_by(product_id) %>% 
  summarise(
    reorder_rate = mean(reordered),
    sales        = n(),
    .groups      = "drop"
  ) %>% 
  filter(sales >= 1000) %>% 
  slice_max(reorder_rate, n = 10) %>% 
  left_join(products, by="product_id") %>% 
  ggplot(aes(fct_reorder(product_name, reorder_rate), reorder_rate)) +
    geom_col() +
    coord_flip() +
    labs(
      title = "å¤è´­ç‡æœ€é«˜çš„ 10 ç§äº§å“",
      x     = NULL,
      y     = "å¤è´­ç‡"
    ) +
    theme_minimal()


# Prior vs Train å…¨å±€å¤è´­ç‡
order_products %>% 
  group_by(src) %>% 
  summarise(
    reorder_rate = mean(reordered),
    .groups      = "drop"
  ) %>% 
  ggplot(aes(src, reorder_rate)) +
    geom_col() +
    labs(
      title = "Prior vs Train å…¨å±€å¤è´­ç‡å¯¹æ¯”",
      x     = NULL,
      y     = "å¤è´­ç‡"
    ) +
    theme_minimal()


```


2.3 äº§å“ç»´åº¦
å„éƒ¨é—¨ & è´§æ¶äº§å“æ•°
```{r order_products, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
products %>% 
  count(department_id, name = "n") %>% 
  left_join(departments, by="department_id") %>% 
  ggplot(aes(fct_reorder(department, n), n)) +
    geom_col() +
    coord_flip() +
    labs(title="å„éƒ¨é—¨äº§å“æ•°", x=NULL, y="äº§å“æ•°") +
    theme_minimal()

products %>% 
  count(aisle_id, name="n") %>% 
  left_join(aisles, by="aisle_id") %>% 
  slice_max(n, n=10) %>% 
  ggplot(aes(fct_reorder(aisle, n), n)) +
    geom_col() +
    coord_flip() +
    labs(title="Top10 è´§æ¶çš„äº§å“æ•°", x=NULL, y="äº§å“æ•°") +
    theme_minimal()


```
```{r define-prod-with-aisle, echo=FALSE, message=FALSE}
prod_with_aisle <- products %>% 
  left_join(aisles, by = "aisle_id")
```

```{r order_products_missing_aisle, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# 1. è®¡ç®— missingâ€aisle ratio
missing_stats <- products %>%
  # bring in the aisle names
  left_join(aisles, by = "aisle_id") %>%
  # now we can filter on the aisle column
  filter(aisle == "missing") %>%
  summarise(
    Missing_Count = n(),
    Total_Products = nrow(products),
    Missing_Pct = percent(Missing_Count / Total_Products)
  )

missing_stats %>% 
  kable(caption = "Products with aisle == 'missing'")

# 2. Filter out "missing" and plot Top 10
prod_with_aisle %>%
  filter(aisle != "missing") %>%        # drop the missing bucket
  count(aisle, name = "n") %>%          # count products by aisle
  slice_max(n, n = 10) %>%              # select top 10 by count
  ggplot(aes(fct_reorder(aisle, n), n)) +
    geom_col() +
    coord_flip() +
    labs(
      title = "Top 10 è´§æ¶çš„äº§å“æ•°ï¼ˆæ’é™¤ 'missing'ï¼‰",
      x     = NULL,
      y     = "äº§å“æ•°"
    ) +
    theme_minimal()
```


å¤è´­ç‡æœ€é«˜ TopN äº§å“
```{r order_products_TopN, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
order_products %>% 
  group_by(product_id) %>% 
  summarise(
    sales = n(),
    reorder_rate = mean(reordered)
  ) %>% 
  filter(sales > 1000) %>%             # è¿‡æ»¤é”€é‡å¤ªå°çš„å™ªå£°
  slice_max(reorder_rate, n=10) %>%    # å¤è´­ç‡ Top10
  left_join(products, by="product_id") %>% 
  ggplot(aes(fct_reorder(product_name, reorder_rate), reorder_rate)) +
    geom_col() +
    coord_flip() +
    labs(
      title="å¤è´­ç‡æœ€é«˜çš„ 10 ç§äº§å“",
      x=NULL, y="å¤è´­ç‡"
    ) +
    theme_minimal()

```


3. å¤šè¡¨è”åˆåˆ†æ
3.1 çƒ­é—¨éƒ¨é—¨ & é€šé“

```{r Popular Departments & Channels, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
order_products %>% 
  count(product_id, name="sales") %>% 
  left_join(products,    by="product_id") %>% 
  left_join(departments,by="department_id") %>% 
  group_by(department) %>% 
  summarise(
    total_sales   = sum(sales),
    avg_reorder   = mean(order_products$reordered[order_products$product_id %in% product_id])
  ) %>% 
  arrange(desc(total_sales)) %>% 
  slice_head(n=10)


```

3.2 ç”¨æˆ·è´­ä¹°è¡Œä¸ºåˆ†ç¾¤ï¼ˆRFMï¼‰
```{r RFM, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# RFM ç¤ºä¾‹
rfm <- orders %>% 
  group_by(user_id) %>% 
  summarise(
    recency   = as.numeric(today() - max(order_number)),  # è‹¥æœ‰å…·ä½“æ—¥æœŸå­—æ®µè¯·æ›¿æ¢
    frequency = n(),
    monetary  = NA_real_                             # æ— é‡‘é¢å­—æ®µå¯ç•™ç©ºæˆ–ç”¨ order_number ä¼°ç®—
  )

# ç®€æ˜“åˆ†ç¾¤
rfm %>% 
  mutate(
    R_score = ntile(-recency, 5),
    F_score = ntile(frequency, 5)
  ) %>% 
  ggplot(aes(F_score, R_score)) +
    geom_jitter(alpha=0.3) +
    labs(
      title="ç”¨æˆ· RFM åˆ†å¸ƒ (ç®€æ˜“ç‰ˆ)",
      x="Frequency Score", y="Recency Score"
    ) +
    theme_minimal()


```

RFM åŸºç¡€çŸ¥è¯†
Recency (R)æ–°è¿‘åº¦ (R)ï¼šè·ç¦»å®¢æˆ·ä¸Šæ¬¡ä¸‹å•çš„æ—¶é—´ã€‚

Frequency (F) é¢‘ç‡ (F)ï¼šä»–ä»¬æ€»å…±ä¸‹å•äº†å¤šå°‘å•ã€‚

(Monetary (M) is left out here because we donâ€™t have $-value fields.)

ç»¼åˆèµ·æ¥ï¼ŒRFM ç”¨äºè¯†åˆ«ä»¥ä¸‹ç¾¤ä½“ï¼š

R-score	      F-score	          Who these are
High        	High	            Champions (æœ€ä½³!)
High        	Low	              New or About-to-Sleep æ–°å®¢æˆ·æˆ–å³å°†å…¥é©»ï¼ˆæœ‰æ—¶é«˜æ–°è¿‘åº¦ä»…æŒ‡é¦–æ¬¡ä¸‹å•ï¼‰
Low	          High            	Loyal but Inactive å¿ è¯šä½†ä¸æ´»è·ƒï¼ˆè¿‡å»ç»å¸¸è´­ä¹°ï¼Œä½†æœ€è¿‘æ²¡æœ‰ï¼‰
Low	          Low	              At Risk or Lost å¤„äºé£é™©æˆ–å¯èƒ½ä¼šæµå¤±





4. æ—¶åºä¸è¶‹åŠ¿
```{r time, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# æ—¥çº§è®¢å•é‡
orders %>% 
  mutate(order_date = today() - days_since_prior_order) %>%  # éœ€çœŸå®æ—¥æœŸåˆ—æ›¿æ¢
  count(order_date) %>% 
  ggplot(aes(order_date, n)) +
    geom_line() +
    labs(title="æ—¥çº§è®¢å•é‡è¶‹åŠ¿", x=NULL, y="è®¢å•æ•°") +
    theme_minimal()


```
5 æœˆ 26 æ—¥å·¦ä¾§çš„å³°å€¼æ˜¯ç”±äºåˆæˆ `order_date` çš„æ–¹å¼é€ æˆçš„ï¼š
`orders.csv` ä¸­**å®é™…ä¸Šæ²¡æœ‰çœŸæ­£çš„æ—¥å†æ—¥æœŸ**â€”â€”åªæœ‰
* `order_dow` (0-6)
* `order_hour_of_day`
* `days_since_prior_order`ï¼ˆä¸Šé™ä¸º 30ï¼›ä¸é€‚ç”¨äºé¦–å•ï¼‰
é€šè¿‡æ‰§è¡Œ
mutate(order_date = today() - days_since_prior_order)
æ‰€æœ‰ `days_since_prior_order == 30` çš„è®¢å•ï¼ˆå³æ‰€æœ‰è¶…è¿‡ 30 å¤©çš„è®¢å•ï¼‰æ˜ å°„åˆ°**ä¸€ä¸ªå•ä¸€æ—¥æœŸ**ï¼ˆä»Šå¤©å‡ 30ï¼‰ã€‚è¿™ä¼šå°†æ•°ç™¾ä¸‡è¡Œæ•°æ®é›†ä¸­åˆ°è¯¥æ—¥æœŸï¼Œå› æ­¤ä¼šå‡ºç°å·¨å¤§çš„å³°å€¼ã€‚

å¦‚ä½•ä¿®å¤
1. çœŸå®çš„è®¢å•æ—¶é—´æˆ³ - æ²¡æœ‰ã€‚ã€‚ã€‚
2. ä½¿ç”¨èµ·å§‹æ—¥æœŸé”šç‚¹è¿›è¡Œè¿‘ä¼¼
    ä¸ºæ¯ä¸ªç”¨æˆ·çš„ç¬¬ä¸€ä¸ªè®¢å•é€‰æ‹©ä¸€ä¸ªä»»æ„çš„â€œé”šç‚¹â€æ—¥æœŸï¼Œç„¶åç´¯è®¡æ·»åŠ  `days_since_prior_order` åç§»é‡ï¼Œä»¥é‡å»ºä¼ªæ—¥å†
    a. å…ˆæŠŠæ¯ä¸ªç”¨æˆ·çš„ NAï¼ˆé¦–å•ï¼‰å½“ä½œ 0 å¤©é—´éš”ã€‚
    b. å¯¹æ¯ä¸ªç”¨æˆ·æŒ‰ order_number ç´¯åŠ è¿™äº›å¤©æ•°ï¼Œå¾—åˆ° cum_daysã€‚
    c. å‡è®¾ã€Œæœ€åä¸€æ¬¡ä¸‹å•ã€å¯¹åº”ä»Šå¤©ï¼ˆæˆ–ä¸€ä¸ªæŒ‡å®šçš„å›ºå®šæ—¥æœŸï¼‰ï¼Œåˆ™é”šç‚¹ anchor_date = today() âˆ’ max(cum_days)
    d. æœ€ç»ˆæ—¥æœŸ = anchor_date + cum_daysã€‚
    
```{r Pseudo-calendar, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# ä»¥ä»Šå¤©ä¸ºâ€œæœ€åä¸€æ¬¡ä¸‹å•æ—¥â€åŸºå‡†ï¼›ä¹Ÿå¯æ”¹æˆ as.Date("2025-06-23")
base_date <- today()

orders_with_dates <- orders %>%
  arrange(user_id, order_number) %>% 
  group_by(user_id) %>% 
  mutate(
    # å°† NAï¼ˆé¦–å•ï¼‰è§†ä¸º 0 å¤©
    days = replace_na(days_since_prior_order, 0),
    # ç´¯ç§¯å¤©æ•°
    cum_days = cumsum(days),
    # è®¡ç®—æ¯ä¸ªç”¨æˆ·çš„é”šç‚¹æ—¥æœŸ
    anchor_date = base_date - max(cum_days),
    # é‡å»ºä¼ªè®¢å•æ—¥æœŸ
    order_date = anchor_date + cum_days
  ) %>% 
  ungroup() %>% 
  select(-days, -cum_days, -anchor_date)

# çœ‹ä¸€ä¸‹ç¤ºä¾‹
orders_with_dates %>% 
  filter(user_id %in% c(1,2,3)) %>% 
  select(user_id, order_number, days_since_prior_order, order_date) %>% 
  head(10) %>% 
  knitr::kable()

```

```{r Trend Chart, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
orders_with_dates %>% 
  count(order_date) %>% 
  ggplot(aes(order_date, n)) +
    geom_line() +
    labs(
      title = "ä¼ªæ—¥å†ä¸‹çš„æ—¥çº§è®¢å•é‡è¶‹åŠ¿",
      x = NULL, y = "è®¢å•æ•°"
    ) +
    theme_minimal()
```


é”šå®šâ€œä¸Šæ¬¡è®¢å• = ä»Šå¤©â€ä¼šå¯¼è‡´ä¸æ­£å¸¸çš„å³°å€¼ ï¼ˆä¸å¯è¡Œï¼‰

ä¸¤ç§æ›´ç®€å•çš„æ›¿ä»£æ–¹æ¡ˆ
A) ç»˜åˆ¶ ç›¸å¯¹æ—¶é—´è½´
```{r relative timeline, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
orders_rel <- orders %>%
  arrange(user_id, order_number) %>%
  group_by(user_id) %>%
  mutate(
    days     = replace_na(days_since_prior_order, 0),
    cum_days = cumsum(days)
  ) %>%
  ungroup()

# Only re-orders (drop cum_days == 0)
orders_rel %>%
  filter(cum_days > 0) %>%
  count(cum_days) %>%
  ggplot(aes(cum_days, n)) +
    geom_line() +
    labs(
      title = "Trend by Days Since First Order (Re-orders Only)",
      x     = "Days Since First Order",
      y     = "Re-order Count"
    ) +
    theme_minimal()

```



B) é”šå®šåˆ°**ä¸­ç‚¹**æˆ–äººä¸ºè®¾å®šçš„â€œå¼€å§‹æ—¥æœŸâ€
```{r artificial start date, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
base_date <- as.Date("2024-01-01")  # fixed start

orders_fake <- orders %>%
  arrange(user_id, order_number) %>%
  group_by(user_id) %>%
  mutate(
    days       = replace_na(days_since_prior_order, 0),
    cum_days   = cumsum(days),
    order_date = base_date + cum_days
  ) %>%
  ungroup()

# Only re-orders (drop the zero-day, i.e. first orders)
orders_fake %>%
  filter(order_date > base_date) %>%
  count(order_date) %>%
  ggplot(aes(order_date, n)) +
    geom_line() +
    labs(
      title = "Pseudo-calendar Trend (Re-orders Only, Jan 1 2024 start)",
      x     = "Order Date",
      y     = "Re-order Count"
    ) +
    theme_minimal()

```

è¿™ä¸¤å¼ å›¾å±•ç¤ºçš„æ˜¯æ¯ä¸ªç”¨æˆ·åœ¨é¦–æ¬¡ä¸‹å•ä»¥åå„ä¸ªâ€œå¤©â€ä¸Šçš„å¤è´­æ¬¡æ•°ï¼Œåªç»Ÿè®¡äº†cum_days > 0ï¼ˆä¹Ÿå°±æ˜¯ç¬¬äºŒæ¬¡åŠä»¥åçš„è®¢å•ï¼‰ï¼Œä»è€Œå‰”é™¤äº†é‚£æ¡â€œæ‰€æœ‰äººé¦–å•é›†ä¸­åœ¨ 0 å¤©â€ çš„å·¨å¤§å³°å€¼

1. 30 å¤©å¤„çš„å°–å³°
    ç”±äºåŸå§‹å­—æ®µ days_since_prior_order è¢« æˆªæ–­åœ¨ 0â€“30 å¤©ï¼Œæ‰€æœ‰è¶…è¿‡ 30 å¤©çš„å®é™…å¤è´­éƒ½è¢«å½“ä½œ 30 å¤©æ¥è®°å½•ï¼Œæ‰€ä»¥åœ¨â€œ30 å¤©â€ä½ç½®å‡ºç°ä¸€ä¸ªå¼‚å¸¸å¤§çš„å³°å€¼ã€‚ä½†æ˜¯å½“ä¸€ä¸ªç”¨æˆ·ç»§ç»­ä¸‹ç¬¬ 4ã€5ã€6â€¦ å•æ—¶ï¼Œä¼šæŠŠä¸€æ¬¡æ¬¡çš„â€œ30 å¤©â€ç´¯åŠ è¿›ã€‚å› æ­¤ï¼Œcum_days ä¼šå¾ˆè‡ªç„¶åœ°è·‘åˆ° 60ã€90ã€120â€¦ è¿™äº›æ•°å€¼â€”â€”å¯¹åº”ç”¨æˆ·åœ¨ç¬¬ 2ã€3ã€4â€¦ æ¬¡å¤è´­æ—¶ï¼Œæ¯æ¬¡éƒ½â€œè‡³å°‘ 30 å¤©â€åæ‰ä¹°
2. 7 å¤©ä¸ºå‘¨æœŸçš„æ³¢åŠ¨
    å¯ä»¥çœ‹åˆ°é™¤äº† 30 å¤©ä¸»å³°ä»¥å¤–ï¼Œå›¾ä¸Šè¿˜æœ‰è®¸å¤šå°å³°ï¼Œå¤§çº¦é—´éš” 7 å¤©å‡ºç°ä¸€æ¬¡â€”â€”è¿™åæ˜ äº†ç”¨æˆ·æœ‰ æ¯å‘¨è´­ç‰© çš„è¡Œä¸ºä¹ æƒ¯ã€‚
3. éšæ—¶é—´çš„è¡°å‡è¶‹åŠ¿
    éšç€è‡ªé¦–æ¬¡ä¸‹å•ä»¥æ¥çš„å¤©æ•°å¢åŠ ï¼Œå¤è´­æ¬¡æ•°åœ¨æ•´ä½“ä¸Šå‘ˆ æŒ‡æ•°å‹è¡°å‡ï¼Œè¯´æ˜å¤§å¤šæ•°ç”¨æˆ·ä¼šéšç€æ—¶é—´æ¨ç§»é€æ¸å‡å°‘ä¸‹å•é¢‘ç‡ï¼Œåªæœ‰å°‘æ•°â€œé«˜å¿ è¯šåº¦â€ç”¨æˆ·ä¼šæŒç»­å¤è´­ã€‚
4. å‰å‡ å¤©çš„ä¸Šå‡
    åœ¨ç¬¬ 1â€“10 å¤©å†…çš„æ›²çº¿ä»é›¶ç‚¹ä¸Šæ¥ä¼šæœ‰ä¸€ä¸ªä¸Šå‡æœŸï¼Œè¯´æ˜å¾ˆå¤šç”¨æˆ·å–œæ¬¢åœ¨é¦–æ¬¡å°è¯•åä¸ä¹…å°±è¿›è¡Œç¬¬äºŒæ¬¡è´­ä¹°ã€‚

ä»·å€¼ä¸åº”ç”¨

  å‘¨æœŸæ€§ä¿ƒé”€ï¼šå¯ä»¥é’ˆå¯¹â€œæ¯å‘¨å¤è´­â€çš„äººç¾¤è®¾è®¡å‘¨æœŸæ€§è¥é”€ï¼ˆä¾‹å¦‚ 7 æ—¥å›è´­æé†’ï¼‰ã€‚
  ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šæ ¹æ®å¤è´­è¡°å‡æ›²çº¿ï¼Œè¯†åˆ«â€œæµå¤±é«˜é£é™©æœŸâ€ï¼ˆæ¯”å¦‚ç¬¬ 20â€“30 å¤©ï¼‰å¹¶æ¨é€æ¿€åŠ±ã€‚
  æ•°æ®æ ¡å‡†ï¼š30 å¤©æˆªæ–­å³°æé†’æˆ‘ä»¬ï¼Œç”¨æ­¤å­—æ®µåšæ—¶é—´åˆ†ææ—¶è¦å°å¿ƒæˆªæ–­åå·®ï¼›å¦‚æœéœ€è¦ï¼Œæ›´ç»†ç²’åº¦çš„å¤©æ•°æ•°æ®ä¼šæ›´å‡†ç¡®ã€‚
  æ•°æ®é™åˆ¶æç¤ºï¼šå³°å€¼éƒ½æ˜¯â€œâ‰¥30 å¤©â€æ‰“åŒ…ï¼Œå› æ­¤æ— æ³•åŒºåˆ†çœŸå®æ˜¯ 31 å¤©è¿˜æ˜¯ 90 å¤©ï¼Œåªèƒ½çœ‹åˆ°â€œè‡³å°‘ä¸€ä¸ªæœˆâ€è¿™ä¸ªåˆ†æ®µçš„å¼ºåº¦ã€‚

5. ç›¸å…³æ€§ä¸èšç±»
```{r corrplot, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# ç›¸å…³æ€§çŸ©é˜µ
num_df <- orders %>% select_if(is.numeric)
corr_mat <- cor(num_df, use="pairwise.complete.obs") # è®¡ç®—æ¯ä¸€å¯¹æ•°å€¼åˆ—çš„çš®å°”é€Šç›¸å…³ç³»æ•°ï¼Œè‡ªåŠ¨è·³è¿‡ç¼ºå¤±å€¼ã€‚ç»“æœæ˜¯ä¸€ä¸ª 5Ã—5 çš„å¯¹ç§°çŸ©é˜µï¼Œå…ƒç´ å€¼åœ¨ â€“1 åˆ° +1 ä¹‹é—´
corrplot::corrplot(corr_mat, method="ellipse") # ç”¨æ¤­åœ†çš„å½¢çŠ¶å’Œé¢œè‰²æ·±æµ…æ¥å¯è§†åŒ–ç›¸å…³ç³»æ•°ï¼š æ·±è“ï¼†ç»†é•¿ è¡¨ç¤ºå¼ºæ­£ç›¸å…³ï¼ˆæ¥è¿‘ +1ï¼‰ï¼›æ·±çº¢ï¼†æ‰å®½ è¡¨ç¤ºå¼ºè´Ÿç›¸å…³ï¼ˆæ¥è¿‘ â€“1ï¼‰ï¼›æµ…ç°/æ‰åœ† è¡¨ç¤ºæ— æˆ–å¼±ç›¸å…³ï¼ˆæ¥è¿‘ 0ï¼‰
```
order_number ä¸ user_idï¼šæ­£ç›¸å…³å¾ˆé«˜ï¼ˆå› ä¸ºæ¯ä¸ªç”¨æˆ·çš„è®¢å•åºå·ä» 1 å¼€å§‹è‡ªå¢ï¼‰ï¼Œè¿™å®Œå…¨æ˜¯æ•°æ®ç»“æ„å†³å®šçš„ã€‚
order_number ä¸ days_since_prior_orderï¼šè½»å¾®è´Ÿç›¸å…³ï¼Œè¯´æ˜ç”¨æˆ·ä¸‹å•æ¬¡æ•°è¶Šå¤šï¼Œå¹³å‡æ¯æ¬¡ä¸‹å•é—´éš”å¾€å¾€è¶ŠçŸ­ï¼ˆå¿ è¯šç”¨æˆ·å¤è´­æ›´é¢‘ç¹ï¼‰ã€‚
å…¶ä»–ç»„åˆåŒæ ·åæ˜ äº†â€œç”¨æˆ·æ´»è·ƒåº¦â€ï¼ˆé«˜ order_number â†” ä½ days_since_prior_orderï¼‰ç­‰ç›´è§‚å…³ç³»ã€‚


```{r K-Means Clustering, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
# ç”¨æˆ·èšç±»
cluster_df <- rfm %>% select(recency, frequency) %>% scale()
set.seed(42)
km <- kmeans(cluster_df, centers=4)
rfm$cluster <- factor(km$cluster)

rfm %>% 
  # å»æ‰å¯èƒ½çš„ NA
  filter(!is.na(recency) & !is.na(frequency) & !is.na(cluster)) %>% 
  ggplot(aes(x = frequency, y = recency, color = cluster)) +
    geom_jitter(alpha = 0.4, width = 0.2, height = 0.2, size = 1.5) +
    scale_y_reverse() +   # recency è¶Šå°è¶Šè¿‘æœŸï¼Œå€’è½¬ Y è½´æ›´ç›´è§‚
    scale_x_continuous(labels = scales::comma) +
    labs(
      title    = "Râ€“F ç”¨æˆ·èšç±»åˆ†å¸ƒ",
      subtitle = "æ¯ä¸ªç‚¹ä»£è¡¨ä¸€ä¸ªç”¨æˆ·ï¼Œé¢œè‰²è¡¨ç¤º K-means åˆ†ç¾¤",
      x        = "Frequency (æ€»è®¢å•æ•°)",
      y        = "Recency (è·ä»Šå¤©æ•°ï¼Œå€’åº)",
      color    = "Cluster"
    ) +
    theme_minimal() +
    theme(
      legend.position = "right",
      plot.subtitle   = element_text(size = 10)
    )
```



ä¹‹å‰çš„RFMæ˜¯ç”¨åˆ†ä½æ•°åˆ†ç®± (ntile) çš„æ–¹æ³•ç»˜åˆ¶ R å’Œ F ç½‘æ ¼
æŒ‰æ–°è¿‘åº¦å¯¹ç”¨æˆ·è¿›è¡Œæ’åºï¼Œå¹¶ä¸ºæ¯ä¸ªæŒ‡æ ‡å°†å…¶åˆ’åˆ†ä¸º **5 ä¸ªå¤§å°ç›¸ç­‰çš„æ¡¶**ï¼ˆåˆ†ä½æ•°ï¼‰ï¼Œç„¶åç»˜åˆ¶ R_score ä¸ F_score çš„å…³ç³»å›¾ã€‚
**ä¼˜ç‚¹ï¼š**éå¸¸é€æ˜ä¸”æ˜“äºè§£é‡Šï¼ˆâ€œæ­¤å•å…ƒæ ¼æ˜¯æœ€è¿‘å‰ 20% çš„æ•°æ®ï¼Œä¹Ÿæ˜¯æœ€å¸¸å‡ºç°çš„å‰ 20% çš„æ•°æ®â€ï¼‰ã€‚
**ç¼ºç‚¹ï¼š** 1.å³ä½¿æ•°æ®åˆ†å¸ƒä¸å¹³è¡¡ï¼Œä¹Ÿä¼šåœ¨ç¬¬ 20ã€40ã€60ã€80 ä¸ªç™¾åˆ†ä½æ•°å¤„æ–½åŠ **ä¸¥æ ¼çš„æˆªæ–­**ã€‚ 2.ä¸è€ƒè™‘è”åˆåˆ†å¸ƒçš„â€œå½¢çŠ¶â€ï¼›å•ç‹¬å¤„ç†æ¯ä¸ªè½´ã€‚

K å‡å€¼èšç±» â€” â€œåŸºäºè·ç¦»çš„ç»†åˆ†â€
å°†ä¸¤ä¸ªæŒ‡æ ‡æ ‡å‡†åŒ–ï¼ˆå‡å€¼ 0ï¼Œæ ‡å‡†å·® 1ï¼‰ï¼Œç„¶åè¿è¡Œ â€‹â€‹K å‡å€¼èšç±»å°†ç”¨æˆ·åˆ’åˆ†ä¸º **4 ä¸ªèšç±»**ï¼Œä»¥æœ€å°åŒ–äºŒç»´ R-F ç©ºé—´ä¸­çš„èšç±»å†…æ–¹å·®ã€‚
**è¾“å‡ºï¼š** å››ä¸ªç»„ï¼Œæ¯ä¸ªç»„éƒ½æœ‰å„è‡ªçš„è´¨å¿ƒï¼ˆä¾‹å¦‚â€œé«˜é¢‘/é«˜é¢‘â€ã€â€œä½é¢‘/ä¸­é¢‘â€ç­‰ï¼‰ã€‚
**ä¼˜ç‚¹ï¼š** 1.èšç±»åŸºäº**å®é™…æ•°æ®å¯†åº¦**å’Œè‡ªç„¶åˆ†ç»„ï¼Œè€Œéä»»æ„ç™¾åˆ†ä½æ•°ã€‚ 2.å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©ä»»æ„æ•°é‡çš„èšç±»ã€‚
**ç¼ºç‚¹ï¼š** 1.å¦‚æœåˆ©ç›Šç›¸å…³è€…æœŸæœ›â€œå‰ 20% = VIPâ€çš„é€»è¾‘ï¼Œåˆ™æ›´éš¾è§£é‡Šã€‚ 2.å¿…é¡»äº‹åè§£é‡Šæ¯ä¸ªèšç±»çš„å«ä¹‰ï¼ˆä¾‹å¦‚ï¼Œèšç±» 1 =â€œæ–°æ‰‹â€ï¼Œèšç±» 2 =â€œæ½œåœ¨é«˜æ¶ˆè´¹ç”¨æˆ·â€ï¼‰ã€‚

å¦‚æœè®¤ä¸ºå®¢æˆ·æ„æˆæ˜¯**è‡ªç„¶ç¾¤ä½“**ï¼ˆä¾‹å¦‚ï¼Œä¸ 20% çš„å‰Šå‡ä¸ä¸€è‡´çš„ä¸­é¢‘â€œæœ€ä½³ç‚¹â€ï¼‰ï¼Œå¹¶ä¸”å¸Œæœ›æ•°æ®èƒ½å¤Ÿé©±åŠ¨ç»†åˆ†å®šä¹‰ï¼Œé‚£ä¹ˆ**K å‡å€¼**ä¼šæ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚

æ•£ç‚¹å›¾â€œå¤ªâ€çº¿æ€§äº†ï¼Œå› ä¸º**æ–°è¿‘åº¦**è®¡ç®—æ–¹å¼æ˜¯ï¼šrecency = as.numeric(today() - max(order_number)) å®é™…ä¸Šï¼Œå®ƒçš„ä½œç”¨æ˜¯ recency_i = today() - (ç”¨æˆ· i çš„æœ€é«˜ order_number) æ‰€ä»¥ï¼Œå¦‚æœç”¨æˆ· i ä¸‹äº† 50 ä¸ªè®¢å•ï¼Œå°±æ˜¯åœ¨æ‰§è¡Œ `today() - 50`â€”â€”è®¢å•æ•°é‡å’Œâ€œæ–°è¿‘åº¦â€ä¹‹é—´å®Œç¾çš„ä¸€ä¸€å¯¹åº”å…³ç³»ï¼Œå› æ­¤æ˜¯ç›´çº¿å¯¹è§’çº¿

ä¿®å¤â€œæœ€è¿‘æˆäº¤é‡â€â†’ä½¿ç”¨è‡ªä¸Šæ¬¡è®¢å•ä»¥æ¥çš„å®é™…å¤©æ•°

```{r K-Means Clustering2, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
library(forcats)
# 1. Build pseudo-calendar orders_fake first (if not already in env)
base_date <- as.Date("2024-01-01")

orders_fake <- orders %>% # # ä¸ºæ¯ä¸ªè®¢å•é‡å»ºä¸€ä¸ªä¼ªæ—¥å†æ—¥æœŸ
  arrange(user_id, order_number) %>%
  group_by(user_id) %>%
  mutate(
    days       = replace_na(days_since_prior_order, 0),
    cum_days   = cumsum(days),
    order_date = base_date + cum_days
  ) %>%
  ungroup()

# 2. Compute RFM properly from orders_fake
rfm2 <- orders_fake %>%
  group_by(user_id) %>%
  summarise(
    recency   = as.numeric(today() - max(order_date)),  # è‡ªä¸Šæ¬¡å®é™… order_date ä»¥æ¥çš„å¤©æ•°
    frequency = n(),                                    # è®¢å•æ€»æ•°
    .groups   = "drop"
  )

# 3. K-means clustering
cluster_df <- rfm2 %>% select(recency, frequency) %>% scale()
set.seed(42)
km <- kmeans(cluster_df, centers = 4)
rfm2$cluster <- factor(km$cluster)

# 4. Plot the clusters in RF space
rfm2 %>%
  ggplot(aes(x = frequency, y = recency, color = cluster)) +
    geom_jitter(alpha = 0.4, size = 1.5, width = 0.2, height = 0.2) +
    scale_y_reverse() +  
    scale_x_continuous(labels = scales::comma) +
    labs(
      title    = "Râ€“F ç”¨æˆ·èšç±»åˆ†å¸ƒï¼ˆRecency = days since last orderï¼‰",
      x        = "Frequency (æ€»è®¢å•æ•°)",
      y        = "Recency (å¤©, å€’åº)",
      color    = "Cluster"
    ) +
    theme_minimal()

```

1. **`order_date` æ˜¯ä¸€ä¸ªçœŸæ­£çš„æ—¥å†æ—¥æœŸ**ï¼ˆå°½ç®¡æ˜¯ä¼ªæ—¥å†ï¼‰ï¼Œé€šè¿‡ç´¯è®¡çœŸå®çš„ `days_since_prior_order` åç§»é‡ã€‚
2. **`recency = today() - max(order_date)`** ç°åœ¨è¡¡é‡çš„æ˜¯è‡ªç”¨æˆ·ä¸Šæ¬¡ä¸‹å•ä»¥æ¥çš„å®é™…å¤©æ•°ã€‚
3. ç”±äº **é¢‘ç‡**ï¼ˆè®¢å•æ€»æ•°ï¼‰å’Œ **æ–°è¿‘åº¦**ï¼ˆè‡ªä¸Šæ¬¡ä¸‹å•ä»¥æ¥çš„å¤©æ•°ï¼‰ç°åœ¨æ˜¯ **ä¸¤ä¸ªç‹¬ç«‹çš„çœŸå®ä¸–ç•Œä¿¡å·**ï¼Œå› æ­¤å®ƒä»¬ä¹‹é—´ä¸å­˜åœ¨å¼ºåˆ¶çš„çº¿æ€§å…³ç³»ã€‚


èšç±»é¢œè‰² æ–°è¿‘åº¦ é¢‘ç‡ ä¸šåŠ¡è§£è¯»
1 ğŸ”´ çº¢è‰² é«˜ ä½ é£é™©/ä¼‘çœ 
è®¢å•æ€»æ•°å¾ˆå°‘ï¼Œå¹¶ä¸”å¾ˆé•¿æ—¶é—´æ²¡æœ‰è´­ä¹°ã€‚é€‚åˆç§¯æåœ°è¿›è¡ŒæŒ½å›è¥é”€æ´»åŠ¨ã€‚
2 ğŸŸ¢ ç»¿è‰² ä½ é«˜ å† å†›
ä¸‹å•é¢‘ç‡å¾ˆé«˜ï¼Œå¹¶ä¸”åˆšåˆšè´­ä¹°â€”â€”æ‚¨æœ€å¿ è¯šã€ä»·å€¼æœ€é«˜çš„å®¢æˆ·ã€‚é‡ç‚¹å…³æ³¨ VIP æƒç›Šã€‚
3 ğŸ”µ è“ç»¿è‰² ä¸­ ä½-ä¸­ æ½œåŠ›
ä¸‹å•é¢‘ç‡é€‚ä¸­ï¼Œå¹¶ä¸”è·ç¦»ä¸Šæ¬¡ä¸‹å•æ—¶é—´ä¸é•¿ã€‚å¯ä»¥é€šè¿‡æœ‰é’ˆå¯¹æ€§çš„ä¼˜æƒ æ´»åŠ¨å°†å…¶è½¬åŒ–ä¸ºå¸¸å®¢ã€‚
4 ğŸŸ£ ç´«è‰² ä½-ä¸­ ä¸­-é«˜ å¿ è¯šä½†è€åŒ–
ä¸‹å•é¢‘ç‡ä¸é”™ï¼Œä½†å¾ˆä¹…æ²¡æœ‰ä¸‹å•äº†ã€‚ä»–ä»¬æ­£åœ¨æµå¤±â€”â€”æé†’é‚®ä»¶æˆ–æ–°çš„æ¿€åŠ±æªæ–½å¯ä»¥é‡æ–°æ¿€æ´»ä»–ä»¬ã€‚
