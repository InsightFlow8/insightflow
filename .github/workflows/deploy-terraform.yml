

name: Deploy Terraform S3 Bucket


on:
  workflow_dispatch:

jobs:
  deploy:

    name: Deploy to AWS  # Job 名称
    runs-on: ubuntu-latest  # 指定 runner 镜像

    steps:
      - name: 📥 Checkout repository  # 第一步：把仓库代码检出到 runner 本地
        uses: actions/checkout@v4

      - name: 📦 Setup Terraform  # 第二步：安装 Terraform 环境
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.5  # 指定 Terraform 版本

      - name: 📑 Terraform Init
        id: init
        run: terraform init
        working-directory: terraform/dev

      - name: ✅ Terraform Validate
        id: validate
        run: terraform validate -no-color
        working-directory: terraform/dev

      - name: 📤 Terraform Apply
        id: apply
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          TF_VAR_snowflake_user: ${{ secrets.SNOWFLAKE_USER }}
          TF_VAR_snowflake_password: ${{ secrets.SNOWFLAKE_PASSWORD }}
          TF_VAR_snowflake_account: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          TF_VAR_snowflake_warehouse: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          TF_VAR_snowflake_role: ${{ secrets.SNOWFLAKE_ROLE }}
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        run: |
          terraform apply -auto-approve -var-file="terraform.tfvars.json"
        working-directory: terraform/dev


