---
title: "Imba_data EDA"
author: "Zhenyu Zhang"
date: "2025-06-13"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(data.table)
library(purrr)
library(skimr)
library(tidyverse)
library(scales)
library(knitr)
library(lubridate)
library(DT)
library(ggplot2)
library(scales)
library(corrplot)
library(lubridate)
library(dplyr)
library(mice)
library(future)
library(VIM)
```


```{r load locol-data, warning=FALSE, message=FALSE}
orders                <- read_csv("orders.csv", show_col_types = FALSE)
products              <- read_csv("products.csv", show_col_types = FALSE)
aisles                <- read_csv("aisles.csv", show_col_types = FALSE)
departments           <- read_csv("departments.csv", show_col_types = FALSE)
order_products_prior  <- read_csv("order_products_prior.csv.gz", show_col_types = FALSE)
order_products_train  <- read_csv("order_products_train.csv.gz", show_col_types = FALSE)
```

---
1. raw data pre check
```{r pre_check, warning=FALSE, message=FALSE}
# consistency check Primary key uniqueness check
# prior
order_products_prior %>% 
  summarise(total = n(), 
            distinct_pairs = n_distinct(paste(order_id, product_id, sep = "_")))

# train
order_products_train %>% 
  summarise(total = n(), 
            distinct_pairs = n_distinct(paste(order_id, product_id, sep = "_")))
```
```{r pre_check_2, warning=FALSE, message=FALSE}
# Foreign key integrity check
# prior
order_products_prior %>% anti_join(orders,    by = "order_id")   %>% count()   # åº”ä¸º 0
order_products_prior %>% anti_join(products,  by = "product_id") %>% count()   # åº”ä¸º 0

# train
order_products_train %>% anti_join(orders,    by = "order_id")   %>% count()   # åº”ä¸º 0
order_products_train %>% anti_join(products,  by = "product_id") %>% count()   # åº”ä¸º 0
```


```{r pre_check_3, warning=FALSE, message=FALSE}
# Put all tables into a list
tables <- list(
  orders                 = orders,
  order_products_prior   = order_products_prior,
  order_products_train   = order_products_train,
  products               = products,
  aisles                 = aisles,
  departments            = departments
)

# 1. Total number of missing values in each table
map_int(tables, ~ sum(is.na(.))) %>% 
  enframe(name = "table", value = "n_missing") %>% 
  knitr::kable(caption = "Total number of missing values")

# 2. Missing rate by column in each table
map(tables, ~ map_dbl(., ~ mean(is.na(.)))) %>% 
  map_df(~ .x, .id = "table") %>% 
  pivot_longer(-table, names_to = "column", values_to = "missing_rate") %>% 
  filter(missing_rate > 0) %>% 
  arrange(desc(missing_rate)) %>% 
  knitr::kable(
    caption = "Missing rate by column in each table (only missing columns are listed)",
    digits = 3
  )

```

```{r pre_check_4, warning=FALSE, message=FALSE}
# 3. Calculate the number and rate of missing data for each table and column
missing_detail <- map_df(
  tables,
  ~ tibble(
      column       = names(.x),
      n_missing    = colSums(is.na(.x)),
      missing_rate = colMeans(is.na(.x))
    ),
  .id = "table"
) %>%
  filter(n_missing > 0) %>%
  arrange(table, desc(missing_rate))

missing_detail %>%
  knitr::kable(
    caption = "Detailed Missing Data by Table and Column",
    digits = c(0, 0, 3),
    col.names = c("Table", "Column", "Missing Count", "Missing Rate")
  )

```

```{r pre_check_5, warning=FALSE, message=FALSE}
orders_cleaned <- orders %>% 
  drop_na(days_since_prior_order)
```




```{r EDA for order table, warning=FALSE, message=FALSE}
# Display the first few rows of the tables
# head(orders)

# Use `spec()` and/or `skimr::skim()` to retrieve the full column specification for this data
spec(orders)
skimr::skim(orders)
spec(products)
spec(aisles)
spec(departments)
spec(order_products_prior)
spec(order_products_train)

```
---

2. Single table EDAï¼ˆExplore Data Analysisï¼‰

2.0 å‡†å¤‡å·¥ä½œ
type conversion [æŠŠç¦»æ•£çš„æ•°å­—åˆ—å˜æˆå› å­æˆ–æ•´æ•°ï¼Œä¾¿äºåç»­ç»˜å›¾ä¸æ±‡æ€»]
```{r type conversion, warning=FALSE, message=FALSE}
orders <- orders %>% 
  mutate(
    order_dow          = factor(order_dow, levels = 0:6,
                                labels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")),
    order_hour_of_day  = as.integer(order_hour_of_day),
    eval_set           = factor(eval_set, levels = c("prior","train","test"))
  )


orders_cleaned <- orders_cleaned %>% 
  mutate(
    order_dow          = factor(order_dow, levels = 0:6,
                                labels = c("Sun","Mon","Tue","Wed","Thu","Fri","Sat")),
    order_hour_of_day  = as.integer(order_hour_of_day),
    eval_set           = factor(eval_set, levels = c("prior","train","test"))
  )


order_products_prior <- order_products_prior %>% mutate_all(~ ifelse(is.na(.), ., .))
order_products_train <- order_products_train

products   <- products   %>% mutate(across(c(product_id, aisle_id, department_id), as.integer))
aisles     <- aisles     %>% mutate(aisle_id = as.integer(aisle_id))
departments<- departments%>% mutate(department_id = as.integer(department_id))

```


```{r orders, warning=FALSE, message=FALSE}
orders %>% 
  summarise(
    total_orders = n(),
    total_users  = n_distinct(user_id)
  )


```


2.1 è®¢å• (orders)
æŒ‰æ˜ŸæœŸ & å°æ—¶åˆ†å¸ƒ
```{r orders distribution, warning=FALSE, message=FALSE}
# Order distribution by day of the week
orders_cleaned %>% 
  count(order_dow) %>% 
  ggplot(aes(order_dow, n)) +
    geom_col() +
    labs(
      title = "Order distribution by day of the week",
      x = NULL, y = "Order Number"
    ) +
    theme_minimal()

# Order distribution by hour
orders_cleaned %>% 
  count(order_hour_of_day) %>% 
  ggplot(aes(order_hour_of_day, n)) +
    geom_col() +
    scale_x_continuous(breaks = seq(0,23,by=2)) +
    labs(
      title = "Order distribution by hour",
      x = "Hour", y = "Order Number"
    ) +
    theme_minimal()

```

å¤è´­å‘¨æœŸåˆ†å¸ƒ
```{r repurchase cycle distribution, warning=FALSE, message=FALSE}
orders_cleaned %>% 
  filter(!is.na(days_since_prior_order)) %>% 
  ggplot(aes(days_since_prior_order)) +
    geom_histogram(binwidth = 1) +
    scale_x_continuous(limits = c(0, 30)) +    # æˆªå–å‰ä¸¤ä¸ªæœˆæ›´æ¸…æ™°
    labs(
      title = "Distribution of days between repurchases",
      x = "Days since last order", y = "Frequency"
    ) +
    theme_minimal()

```

ç”¨æˆ·ä¸‹å•æ¬¡æ•°åˆ†å¸ƒ
```{r distribution of order times, warning=FALSE, message=FALSE}
orders_cleaned %>% 
  count(user_id, name = "order_count") %>% 
  ggplot(aes(order_count)) +
    geom_histogram(
      breaks = seq(0, 100, by = 10),
      closed = "right",
      color  = "white"
    ) +
    # linear X axis with 10-unit ticks
    scale_x_continuous(
      breaks = seq(0, 100, by = 10),
      labels = comma_format()
    ) +
    # log10 on Y axis
    scale_y_continuous(
      trans  = "log10",
      labels = comma_format()
    ) +    labs(
      title = "Distribution of Orders Per User",
      x     = "Total Orders per User",
      y     = "Number of Users (log scale)"
    ) +
    theme_minimal()


```


2.2 è®¢å•â€“äº§å“ (order_products)
```{r order_products1, warning=FALSE, message=FALSE}
# åˆå¹¶ç¤ºä¾‹
order_products <- bind_rows(
  order_products_prior  %>% mutate(src = "prior"),
  order_products_train  %>% mutate(src = "train")
)

order_products %>% 
  count(order_id, name="items_per_order") %>% 
  ggplot(aes(items_per_order)) +
    # bins of size 10: [0â€“10),[10â€“20)â€¦ up to 100
    geom_histogram(
      breaks = seq(0,100,by=10), 
      closed = "right", 
      color  = "white"
    ) +
    scale_x_continuous(
      breaks = seq(0,100,by=10),
      labels = seq(0,100,by=10)
    ) +
    scale_y_continuous(
      trans  = "log10",
      labels = scales::comma_format()
    ) +
    labs(
      title = "æ¯ç¬”è®¢å•çš„å•†å“æ•°é‡åˆ†å¸ƒ",
      x     = "å•†å“æ•°é‡",
      y     = "è®¢å•æ•° (log scale)"
    ) +
    theme_minimal()

```

```{r order_products2, warning=FALSE, message=FALSE}
# how often items land in each cart position
order_products %>% 
  count(add_to_cart_order) %>% 
  filter(add_to_cart_order <= 20) %>%   # é™åˆ¶åˆ°å‰20ä¸ªä½ç½®
  ggplot(aes(add_to_cart_order, n)) +
    geom_col() +
    labs(
      title = "åŠ å…¥è´­ç‰©è½¦é¡ºåºåˆ†å¸ƒï¼ˆå‰20ä½ï¼‰",
      x     = "åŠ å…¥é¡ºåº",
      y     = "é¢‘æ¬¡"
    ) +
    theme_minimal()

```


```{r order_products3, warning=FALSE, message=FALSE}
order_products %>% 
  group_by(product_id) %>% 
  summarise(
    avg_pos = mean(add_to_cart_order),
    count   = n(),
    .groups = "drop"
  ) %>% 
  filter(count >= 1000) %>%    # åªçœ‹é”€é‡å¤Ÿå¤§çš„äº§å“
  slice_min(avg_pos, n = 10) %>% 
  left_join(products, by="product_id") %>% 
  ggplot(aes(fct_reorder(product_name, avg_pos), avg_pos)) +
    geom_col() +
    coord_flip() +
    labs(
      title = "å¹³å‡åŠ å…¥è´­ç‰©è½¦é¡ºåºæœ€é å‰çš„10ç§äº§å“",
      x     = NULL,
      y     = "å¹³å‡åŠ å…¥é¡ºåº"
    ) +
    theme_minimal()

```






```{r order_products4, warning=FALSE, message=FALSE}
# overall spread of reorder_rate across products
order_products %>% 
  group_by(product_id) %>% 
  summarise(
    reorder_rate = mean(reordered),
    sales        = n(),
    .groups      = "drop"
  ) %>% 
  ggplot(aes(reorder_rate)) +
    geom_histogram(bins = 50) +
    labs(
      title = "äº§å“å±‚é¢å¤è´­ç‡åˆ†å¸ƒ",
      x     = "å¤è´­ç‡",
      y     = "äº§å“æ•°"
    ) +
    theme_minimal()

# Top-10 å¤è´­ç‡æœ€é«˜äº§å“
order_products %>% 
  group_by(product_id) %>% 
  summarise(
    reorder_rate = mean(reordered),
    sales        = n(),
    .groups      = "drop"
  ) %>% 
  filter(sales >= 1000) %>% 
  slice_max(reorder_rate, n = 10) %>% 
  left_join(products, by="product_id") %>% 
  ggplot(aes(fct_reorder(product_name, reorder_rate), reorder_rate)) +
    geom_col() +
    coord_flip() +
    labs(
      title = "å¤è´­ç‡æœ€é«˜çš„ 10 ç§äº§å“",
      x     = NULL,
      y     = "å¤è´­ç‡"
    ) +
    theme_minimal()


# Prior vs Train å…¨å±€å¤è´­ç‡
order_products %>% 
  group_by(src) %>% 
  summarise(
    reorder_rate = mean(reordered),
    .groups      = "drop"
  ) %>% 
  ggplot(aes(src, reorder_rate)) +
    geom_col() +
    labs(
      title = "Prior vs Train å…¨å±€å¤è´­ç‡å¯¹æ¯”",
      x     = NULL,
      y     = "å¤è´­ç‡"
    ) +
    theme_minimal()


```


2.3 äº§å“ç»´åº¦
å„éƒ¨é—¨ & è´§æ¶äº§å“æ•°
```{r order_products, warning=FALSE, message=FALSE}
products %>% 
  count(department_id, name = "n") %>% 
  left_join(departments, by="department_id") %>% 
  ggplot(aes(fct_reorder(department, n), n)) +
    geom_col() +
    coord_flip() +
    labs(title="å„éƒ¨é—¨äº§å“æ•°", x=NULL, y="äº§å“æ•°") +
    theme_minimal()

products %>% 
  count(aisle_id, name="n") %>% 
  left_join(aisles, by="aisle_id") %>% 
  slice_max(n, n=10) %>% 
  ggplot(aes(fct_reorder(aisle, n), n)) +
    geom_col() +
    coord_flip() +
    labs(title="Top10 è´§æ¶çš„äº§å“æ•°", x=NULL, y="äº§å“æ•°") +
    theme_minimal()


```
```{r define-prod-with-aisle, message=FALSE}
prod_with_aisle <- products %>% 
  left_join(aisles, by = "aisle_id")
```

```{r order_products_missing_aisle, warning=FALSE, message=FALSE}
# 1. è®¡ç®— missingâ€aisle ratio
missing_stats <- products %>%
  # bring in the aisle names
  left_join(aisles, by = "aisle_id") %>%
  # now we can filter on the aisle column
  filter(aisle == "missing") %>%
  summarise(
    Missing_Count = n(),
    Total_Products = nrow(products),
    Missing_Pct = percent(Missing_Count / Total_Products)
  )

missing_stats %>% 
  kable(caption = "Products with aisle == 'missing'")

# 2. Filter out "missing" and plot Top 10
prod_with_aisle %>%
  filter(aisle != "missing") %>%        # drop the missing bucket
  count(aisle, name = "n") %>%          # count products by aisle
  slice_max(n, n = 10) %>%              # select top 10 by count
  ggplot(aes(fct_reorder(aisle, n), n)) +
    geom_col() +
    coord_flip() +
    labs(
      title = "Top 10 è´§æ¶çš„äº§å“æ•°ï¼ˆæ’é™¤ 'missing'ï¼‰",
      x     = NULL,
      y     = "äº§å“æ•°"
    ) +
    theme_minimal()
```


å¤è´­ç‡æœ€é«˜ TopN äº§å“
```{r order_products_TopN, warning=FALSE, message=FALSE}
order_products %>% 
  group_by(product_id) %>% 
  summarise(
    sales = n(),
    reorder_rate = mean(reordered)
  ) %>% 
  filter(sales > 1000) %>%             # è¿‡æ»¤é”€é‡å¤ªå°çš„å™ªå£°
  slice_max(reorder_rate, n=10) %>%    # å¤è´­ç‡ Top10
  left_join(products, by="product_id") %>% 
  ggplot(aes(fct_reorder(product_name, reorder_rate), reorder_rate)) +
    geom_col() +
    coord_flip() +
    labs(
      title="å¤è´­ç‡æœ€é«˜çš„ 10 ç§äº§å“",
      x=NULL, y="å¤è´­ç‡"
    ) +
    theme_minimal()

```


3. å¤šè¡¨è”åˆåˆ†æ
3.1 çƒ­é—¨éƒ¨é—¨ & é€šé“

```{r Popular Departments & Channels, warning=FALSE, message=FALSE}
order_products %>% 
  count(product_id, name="sales") %>% 
  left_join(products,    by="product_id") %>% 
  left_join(departments,by="department_id") %>% 
  group_by(department) %>% 
  summarise(
    total_sales   = sum(sales),
    avg_reorder   = mean(order_products$reordered[order_products$product_id %in% product_id])
  ) %>% 
  arrange(desc(total_sales)) %>% 
  slice_head(n=10)


```

3.2 ç”¨æˆ·è´­ä¹°è¡Œä¸ºåˆ†ç¾¤ï¼ˆRFMï¼‰
```{r RFM, warning=FALSE, message=FALSE}
# RFM ç¤ºä¾‹
rfm <- orders %>% 
  group_by(user_id) %>% 
  summarise(
    recency   = as.numeric(today() - max(order_number)),  # è‹¥æœ‰å…·ä½“æ—¥æœŸå­—æ®µè¯·æ›¿æ¢
    frequency = n(),
    monetary  = NA_real_                             # æ— é‡‘é¢å­—æ®µå¯ç•™ç©ºæˆ–ç”¨ order_number ä¼°ç®—
  )

# ç®€æ˜“åˆ†ç¾¤
rfm %>% 
  mutate(
    R_score = ntile(-recency, 5),
    F_score = ntile(frequency, 5)
  ) %>% 
  ggplot(aes(F_score, R_score)) +
    geom_jitter(alpha=0.3) +
    labs(
      title="ç”¨æˆ· RFM åˆ†å¸ƒ (ç®€æ˜“ç‰ˆ)",
      x="Frequency Score", y="Recency Score"
    ) +
    theme_minimal()


```

RFM åŸºç¡€çŸ¥è¯†
Recency (R)æ–°è¿‘åº¦ (R)ï¼šè·ç¦»å®¢æˆ·ä¸Šæ¬¡ä¸‹å•çš„æ—¶é—´ã€‚

Frequency (F) é¢‘ç‡ (F)ï¼šä»–ä»¬æ€»å…±ä¸‹å•äº†å¤šå°‘å•ã€‚

(Monetary (M) is left out here because we donâ€™t have $-value fields.)

ç»¼åˆèµ·æ¥ï¼ŒRFM ç”¨äºè¯†åˆ«ä»¥ä¸‹ç¾¤ä½“ï¼š

R-score	      F-score	          Who these are
High        	High	            Champions (æœ€ä½³!)
High        	Low	              New or About-to-Sleep æ–°å®¢æˆ·æˆ–å³å°†å…¥é©»ï¼ˆæœ‰æ—¶é«˜æ–°è¿‘åº¦ä»…æŒ‡é¦–æ¬¡ä¸‹å•ï¼‰
Low	          High            	Loyal but Inactive å¿ è¯šä½†ä¸æ´»è·ƒï¼ˆè¿‡å»ç»å¸¸è´­ä¹°ï¼Œä½†æœ€è¿‘æ²¡æœ‰ï¼‰
Low	          Low	              At Risk or Lost å¤„äºé£é™©æˆ–å¯èƒ½ä¼šæµå¤±





4. æ—¶åºä¸è¶‹åŠ¿
```{r time, warning=FALSE, message=FALSE}
# æ—¥çº§è®¢å•é‡
orders %>% 
  mutate(order_date = today() - days_since_prior_order) %>%  # éœ€çœŸå®æ—¥æœŸåˆ—æ›¿æ¢
  count(order_date) %>% 
  ggplot(aes(order_date, n)) +
    geom_line() +
    labs(title="æ—¥çº§è®¢å•é‡è¶‹åŠ¿", x=NULL, y="è®¢å•æ•°") +
    theme_minimal()


```
5 æœˆ 26 æ—¥å·¦ä¾§çš„å³°å€¼æ˜¯ç”±äºåˆæˆ `order_date` çš„æ–¹å¼é€ æˆçš„ï¼š
`orders.csv` ä¸­**å®é™…ä¸Šæ²¡æœ‰çœŸæ­£çš„æ—¥å†æ—¥æœŸ**â€”â€”åªæœ‰
* `order_dow` (0-6)
* `order_hour_of_day`
* `days_since_prior_order`ï¼ˆä¸Šé™ä¸º 30ï¼›ä¸é€‚ç”¨äºé¦–å•ï¼‰
é€šè¿‡æ‰§è¡Œ
mutate(order_date = today() - days_since_prior_order)
æ‰€æœ‰ `days_since_prior_order == 30` çš„è®¢å•ï¼ˆå³æ‰€æœ‰è¶…è¿‡ 30 å¤©çš„è®¢å•ï¼‰æ˜ å°„åˆ°**ä¸€ä¸ªå•ä¸€æ—¥æœŸ**ï¼ˆä»Šå¤©å‡ 30ï¼‰ã€‚è¿™ä¼šå°†æ•°ç™¾ä¸‡è¡Œæ•°æ®é›†ä¸­åˆ°è¯¥æ—¥æœŸï¼Œå› æ­¤ä¼šå‡ºç°å·¨å¤§çš„å³°å€¼ã€‚

å¦‚ä½•ä¿®å¤
1. çœŸå®çš„è®¢å•æ—¶é—´æˆ³ - æ²¡æœ‰ã€‚ã€‚ã€‚
2. ä½¿ç”¨èµ·å§‹æ—¥æœŸé”šç‚¹è¿›è¡Œè¿‘ä¼¼
    ä¸ºæ¯ä¸ªç”¨æˆ·çš„ç¬¬ä¸€ä¸ªè®¢å•é€‰æ‹©ä¸€ä¸ªä»»æ„çš„â€œé”šç‚¹â€æ—¥æœŸï¼Œç„¶åç´¯è®¡æ·»åŠ  `days_since_prior_order` åç§»é‡ï¼Œä»¥é‡å»ºä¼ªæ—¥å†
    a. å…ˆæŠŠæ¯ä¸ªç”¨æˆ·çš„ NAï¼ˆé¦–å•ï¼‰å½“ä½œ 0 å¤©é—´éš”ã€‚
    b. å¯¹æ¯ä¸ªç”¨æˆ·æŒ‰ order_number ç´¯åŠ è¿™äº›å¤©æ•°ï¼Œå¾—åˆ° cum_daysã€‚
    c. å‡è®¾ã€Œæœ€åä¸€æ¬¡ä¸‹å•ã€å¯¹åº”ä»Šå¤©ï¼ˆæˆ–ä¸€ä¸ªæŒ‡å®šçš„å›ºå®šæ—¥æœŸï¼‰ï¼Œåˆ™é”šç‚¹ anchor_date = today() âˆ’ max(cum_days)
    d. æœ€ç»ˆæ—¥æœŸ = anchor_date + cum_daysã€‚
    
```{r Pseudo-calendar, warning=FALSE, message=FALSE}
# ä»¥ä»Šå¤©ä¸ºâ€œæœ€åä¸€æ¬¡ä¸‹å•æ—¥â€åŸºå‡†ï¼›ä¹Ÿå¯æ”¹æˆ as.Date("2025-06-23")
base_date <- today()

orders_with_dates <- orders %>%
  arrange(user_id, order_number) %>% 
  group_by(user_id) %>% 
  mutate(
    # å°† NAï¼ˆé¦–å•ï¼‰è§†ä¸º 0 å¤©
    days = replace_na(days_since_prior_order, 0),
    # ç´¯ç§¯å¤©æ•°
    cum_days = cumsum(days),
    # è®¡ç®—æ¯ä¸ªç”¨æˆ·çš„é”šç‚¹æ—¥æœŸ
    anchor_date = base_date - max(cum_days),
    # é‡å»ºä¼ªè®¢å•æ—¥æœŸ
    order_date = anchor_date + cum_days
  ) %>% 
  ungroup() %>% 
  select(-days, -cum_days, -anchor_date)

# çœ‹ä¸€ä¸‹ç¤ºä¾‹
orders_with_dates %>% 
  filter(user_id %in% c(1,2,3)) %>% 
  select(user_id, order_number, days_since_prior_order, order_date) %>% 
  head(10) %>% 
  knitr::kable()

```

```{r Trend Chart, warning=FALSE, message=FALSE}
orders_with_dates %>% 
  count(order_date) %>% 
  ggplot(aes(order_date, n)) +
    geom_line() +
    labs(
      title = "ä¼ªæ—¥å†ä¸‹çš„æ—¥çº§è®¢å•é‡è¶‹åŠ¿",
      x = NULL, y = "è®¢å•æ•°"
    ) +
    theme_minimal()
```


é”šå®šâ€œä¸Šæ¬¡è®¢å• = ä»Šå¤©â€ä¼šå¯¼è‡´ä¸æ­£å¸¸çš„å³°å€¼ ï¼ˆä¸å¯è¡Œï¼‰

ä¸¤ç§æ›´ç®€å•çš„æ›¿ä»£æ–¹æ¡ˆ
A) ç»˜åˆ¶ ç›¸å¯¹æ—¶é—´è½´
```{r relative timeline, warning=FALSE, message=FALSE}
orders_rel <- orders %>%
  arrange(user_id, order_number) %>%
  group_by(user_id) %>%
  mutate(
    days     = replace_na(days_since_prior_order, 0),
    cum_days = cumsum(days)
  ) %>%
  ungroup()

# Only re-orders (drop cum_days == 0)
orders_rel %>%
  filter(cum_days > 0) %>%
  count(cum_days) %>%
  ggplot(aes(cum_days, n)) +
    geom_line() +
    labs(
      title = "Trend by Days Since First Order (Re-orders Only)",
      x     = "Days Since First Order",
      y     = "Re-order Count"
    ) +
    theme_minimal()

```



B) é”šå®šåˆ°**ä¸­ç‚¹**æˆ–äººä¸ºè®¾å®šçš„â€œå¼€å§‹æ—¥æœŸâ€
```{r artificial start date, warning=FALSE, message=FALSE}
base_date <- as.Date("2024-01-01")  # fixed start

orders_fake <- orders %>%
  arrange(user_id, order_number) %>%
  group_by(user_id) %>%
  mutate(
    days       = replace_na(days_since_prior_order, 0),
    cum_days   = cumsum(days),
    order_date = base_date + cum_days
  ) %>%
  ungroup()

# Only re-orders (drop the zero-day, i.e. first orders)
orders_fake %>%
  filter(order_date > base_date) %>%
  count(order_date) %>%
  ggplot(aes(order_date, n)) +
    geom_line() +
    labs(
      title = "Pseudo-calendar Trend (Re-orders Only, Jan 1 2024 start)",
      x     = "Order Date",
      y     = "Re-order Count"
    ) +
    theme_minimal()

```

è¿™ä¸¤å¼ å›¾å±•ç¤ºçš„æ˜¯æ¯ä¸ªç”¨æˆ·åœ¨é¦–æ¬¡ä¸‹å•ä»¥åå„ä¸ªâ€œå¤©â€ä¸Šçš„å¤è´­æ¬¡æ•°ï¼Œåªç»Ÿè®¡äº†cum_days > 0ï¼ˆä¹Ÿå°±æ˜¯ç¬¬äºŒæ¬¡åŠä»¥åçš„è®¢å•ï¼‰ï¼Œä»è€Œå‰”é™¤äº†é‚£æ¡â€œæ‰€æœ‰äººé¦–å•é›†ä¸­åœ¨ 0 å¤©â€ çš„å·¨å¤§å³°å€¼

1. 30 å¤©å¤„çš„å°–å³°
    ç”±äºåŸå§‹å­—æ®µ days_since_prior_order è¢« æˆªæ–­åœ¨ 0â€“30 å¤©ï¼Œæ‰€æœ‰è¶…è¿‡ 30 å¤©çš„å®é™…å¤è´­éƒ½è¢«å½“ä½œ 30 å¤©æ¥è®°å½•ï¼Œæ‰€ä»¥åœ¨â€œ30 å¤©â€ä½ç½®å‡ºç°ä¸€ä¸ªå¼‚å¸¸å¤§çš„å³°å€¼ã€‚ä½†æ˜¯å½“ä¸€ä¸ªç”¨æˆ·ç»§ç»­ä¸‹ç¬¬ 4ã€5ã€6â€¦ å•æ—¶ï¼Œä¼šæŠŠä¸€æ¬¡æ¬¡çš„â€œ30 å¤©â€ç´¯åŠ è¿›ã€‚å› æ­¤ï¼Œcum_days ä¼šå¾ˆè‡ªç„¶åœ°è·‘åˆ° 60ã€90ã€120â€¦ è¿™äº›æ•°å€¼â€”â€”å¯¹åº”ç”¨æˆ·åœ¨ç¬¬ 2ã€3ã€4â€¦ æ¬¡å¤è´­æ—¶ï¼Œæ¯æ¬¡éƒ½â€œè‡³å°‘ 30 å¤©â€åæ‰ä¹°
2. 7 å¤©ä¸ºå‘¨æœŸçš„æ³¢åŠ¨
    å¯ä»¥çœ‹åˆ°é™¤äº† 30 å¤©ä¸»å³°ä»¥å¤–ï¼Œå›¾ä¸Šè¿˜æœ‰è®¸å¤šå°å³°ï¼Œå¤§çº¦é—´éš” 7 å¤©å‡ºç°ä¸€æ¬¡â€”â€”è¿™åæ˜ äº†ç”¨æˆ·æœ‰ æ¯å‘¨è´­ç‰© çš„è¡Œä¸ºä¹ æƒ¯ã€‚
3. éšæ—¶é—´çš„è¡°å‡è¶‹åŠ¿
    éšç€è‡ªé¦–æ¬¡ä¸‹å•ä»¥æ¥çš„å¤©æ•°å¢åŠ ï¼Œå¤è´­æ¬¡æ•°åœ¨æ•´ä½“ä¸Šå‘ˆ æŒ‡æ•°å‹è¡°å‡ï¼Œè¯´æ˜å¤§å¤šæ•°ç”¨æˆ·ä¼šéšç€æ—¶é—´æ¨ç§»é€æ¸å‡å°‘ä¸‹å•é¢‘ç‡ï¼Œåªæœ‰å°‘æ•°â€œé«˜å¿ è¯šåº¦â€ç”¨æˆ·ä¼šæŒç»­å¤è´­ã€‚
4. å‰å‡ å¤©çš„ä¸Šå‡
    åœ¨ç¬¬ 1â€“10 å¤©å†…çš„æ›²çº¿ä»é›¶ç‚¹ä¸Šæ¥ä¼šæœ‰ä¸€ä¸ªä¸Šå‡æœŸï¼Œè¯´æ˜å¾ˆå¤šç”¨æˆ·å–œæ¬¢åœ¨é¦–æ¬¡å°è¯•åä¸ä¹…å°±è¿›è¡Œç¬¬äºŒæ¬¡è´­ä¹°ã€‚

ä»·å€¼ä¸åº”ç”¨

  å‘¨æœŸæ€§ä¿ƒé”€ï¼šå¯ä»¥é’ˆå¯¹â€œæ¯å‘¨å¤è´­â€çš„äººç¾¤è®¾è®¡å‘¨æœŸæ€§è¥é”€ï¼ˆä¾‹å¦‚ 7 æ—¥å›è´­æé†’ï¼‰ã€‚
  ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šæ ¹æ®å¤è´­è¡°å‡æ›²çº¿ï¼Œè¯†åˆ«â€œæµå¤±é«˜é£é™©æœŸâ€ï¼ˆæ¯”å¦‚ç¬¬ 20â€“30 å¤©ï¼‰å¹¶æ¨é€æ¿€åŠ±ã€‚
  æ•°æ®æ ¡å‡†ï¼š30 å¤©æˆªæ–­å³°æé†’æˆ‘ä»¬ï¼Œç”¨æ­¤å­—æ®µåšæ—¶é—´åˆ†ææ—¶è¦å°å¿ƒæˆªæ–­åå·®ï¼›å¦‚æœéœ€è¦ï¼Œæ›´ç»†ç²’åº¦çš„å¤©æ•°æ•°æ®ä¼šæ›´å‡†ç¡®ã€‚
  æ•°æ®é™åˆ¶æç¤ºï¼šå³°å€¼éƒ½æ˜¯â€œâ‰¥30 å¤©â€æ‰“åŒ…ï¼Œå› æ­¤æ— æ³•åŒºåˆ†çœŸå®æ˜¯ 31 å¤©è¿˜æ˜¯ 90 å¤©ï¼Œåªèƒ½çœ‹åˆ°â€œè‡³å°‘ä¸€ä¸ªæœˆâ€è¿™ä¸ªåˆ†æ®µçš„å¼ºåº¦ã€‚
  

æ·»åŠ æŠ–åŠ¨ï¼ˆjitterï¼‰ä¹Ÿè®¸å¯ä»¥åœ¨å¯è§†åŒ–å’Œç®€å•åˆ†æä¸­ç¼“è§£ â€œæ‰€æœ‰ç”¨æˆ·æœ€åä¸€å•éƒ½èšé›†åœ¨åŒä¸€å¤©â€ æ‰€é€ æˆçš„äººä¸ºå°–å³°ã€‚ æ ¸å¿ƒæ€è·¯æ˜¯åœ¨æ¯ä¸ªç”¨æˆ·çš„é”šç‚¹ï¼ˆanchor_dateï¼‰ä¸Šé™„åŠ ä¸€ä¸ªå°èŒƒå›´çš„éšæœºåç§»ï¼Œä½¿â€œæœ€åä¸€æ¬¡ä¸‹å•â€è¢«æ²¿æ—¶é—´è½´å‡åŒ€æˆ–è¿‘ä¼¼åœ°æ‰“æ•£ã€‚æŠ–åŠ¨çš„å½¢å¼ï¼ˆéšæœºåˆ†å¸ƒï¼‰æœ‰å‡åŒ€åˆ†å¸ƒ (Uniform) & æˆªæ–­æ­£æ€åˆ†å¸ƒ (Truncated Normal)
ä¼˜ç¼ºç‚¹æƒè¡¡ï¼š
ä¼˜ç‚¹	                          ç¼ºç‚¹
â€¢ æ¶ˆé™¤ä¼ªå°–å³°ï¼Œå›¾è¡¨æ›´è‡ªç„¶	      â€¢ å¼•å…¥äººå·¥å™ªå£°ï¼Œç»å¯¹æ—¥æœŸå¤±çœŸ
â€¢ ä¿ç•™ç”¨æˆ·ç›¸å¯¹é¡ºåºå’Œé—´éš”æ¨¡å¼  	â€¢ å¦‚æœåˆ†æä¾èµ–çœŸå®èŠ‚å‡æ—¥/äº‹ä»¶æ—¥æœŸï¼ŒæŠ–åŠ¨åæ— æ³•æ•æ‰
â€¢ ç®€å•æ˜“è¡Œï¼Œä¸éœ€è¦é¢å¤–æ•°æ®	    â€¢ æŠ–åŠ¨èŒƒå›´æˆ–åˆ†å¸ƒè®¾ç½®ä¸å½“ä¼šè¿‡åº¦æ‰­æ›²
```{r Overlay Jitter 1, warning=FALSE, message=FALSE}
# å‡åŒ€åˆ†å¸ƒ - æ¯ä¸ªç”¨æˆ·çš„æœ€åä¸€æ¬¡ä¸‹å•ä¼šå‡åŒ€åˆ†æ•£åœ¨ [cutoff_date - D, cutoff_date] è¿™æ®µåŒºé—´å†…
D <- 7  # D æ˜¯æœŸæœ›æ‰“æ•£çš„å¤©æ•°èŒƒå›´/å‡åŒ€æŠ–åŠ¨èŒƒå›´ ï¼Œæ¯”å¦‚è¿™æ˜¯è®¾ç½®ä¸ºä¸€å‘¨
# æˆªæ–­æ­£æ€åˆ†å¸ƒ - å¤§å¤šæ•°ç”¨æˆ·çš„æœ€åè®¢å•é è¿‘ cutoff_dateï¼Œè€Œåªæœ‰å°‘æ•°ç”¨æˆ·åˆ†å¸ƒè¾ƒè¿œ
Ïƒ <- 3  # æ ‡å‡†å·®ï¼Œå†³å®šåˆ†æ•£ç¨‹åº¦

cutoff_date <- today()

# 1. Uniform Jitter
orders_uni <- orders_rel %>%
  group_by(user_id) %>%
  mutate(
    jitter_u   = round(runif(1, min = 0, max = D)),
    anchor_u   = cutoff_date - max(cum_days) - jitter_u,
    order_date = anchor_u + cum_days
  ) %>%
  ungroup()

# 2. Truncated Normal Jitter
orders_trunc <- orders_rel %>%
  group_by(user_id) %>%
  mutate(
    jitter_t   = pmax(0, round(rnorm(1, mean = 0, sd = Ïƒ))),
    anchor_t   = cutoff_date - max(cum_days) - jitter_t,
    order_date = anchor_t + cum_days
  ) %>%
  ungroup()

# 3. Compute counts by cum_days for each jitter type
df_uni_cal   <- orders_uni   %>% filter(cum_days>0) %>% count(order_date) %>% mutate(Jitter="Uniform")
df_trunc_cal <- orders_trunc %>% filter(cum_days>0) %>% count(order_date) %>% mutate(Jitter="Truncated Normal")
df_cal       <- bind_rows(df_uni_cal, df_trunc_cal)

# 4. Combine and plot
ggplot(df_cal, aes(x = order_date, y = n, color = Jitter, linetype = Jitter)) +
  geom_line(size = 0.5, alpha = 0.7) +
  labs(
    title = "Pseudo-calendar Trend with Uniform vs Truncated Normal Jitter",
    x     = "Order Date",
    y     = "Re-order Count"
  ) +
  theme_minimal()
```

Uniform æŠ–åŠ¨ é‡Œï¼Œjitter_u = round(runif(1, 0, D)) ä¼šæœ‰ä¸å°‘ jitter_u == 0ï¼Œäºæ˜¯è¿™äº›ç”¨æˆ·çš„æœ€åä¸€å•å°±è¢«æ˜ å°„åˆ° order_date = cutoff_date - 0 = cutoff_dateï¼Œå½¢æˆä¸€ä¸ªå·¨é‡å°–å³°ã€‚

Truncated Normal æŠ–åŠ¨ æ›´æ˜æ˜¾ï¼šæˆªæ–­å jitter_t é‡Œç»å¤§å¤šæ•°ä¹Ÿæ˜¯ 0ï¼Œåªæœ‰å°‘æ•°>0ï¼Œæ‰€ä»¥æ›´é›†ä¸­è¿‡å¤šç‚¹ã€‚

æƒ³åŒæ—¶ä¿ç•™å‘¨å‘¨æœŸï¼‹æ‹‰å¹³â€œæœ€åä¸€å•â€å°–å³°ï¼Œæœ‰ä¸¤ç§æ”¹æ³•ï¼š
1. æŠ–åŠ¨é’‰åˆ°æ•´å‘¨ï¼š
æŠŠ jitter_u é™åˆ¶ä¸ºâ€œæ•´å‘¨åç§»â€ï¼Œä¾‹å¦‚
# 0â€“W å‘¨éšæœºåç§»ï¼Œæ¯å‘¨ä¿æŒåŒä¸€å¤©
W = 4  # æœ€å¤šå››å‘¨å†…
jitter_u = 7 * sample(0:W, 1)
è¿™æ ·æ‰€æœ‰è®¢å•éƒ½åœ¨åŒä¸€æ˜ŸæœŸå‡ ä¸Šï¼ˆä¸æ‰“æ•£å‘¨å‘¨æœŸï¼‰ï¼Œä½†ç”¨æˆ·â€œæœ€åä¸€å•â€ä¼šè¢«å¹³ç§» 0ã€7ã€14ã€21ã€28 å¤©ã€‚

2. åªæ’é™¤å½“å¤©ï¼ˆä¸æŠ–åŠ¨ 0ï¼‰ï¼‹ä¿ç•™å°èŒƒå›´æŠ–åŠ¨
# ä¿è¯ jitter_u â‰¥ 1 ä¸” <7ï¼Œè¿™æ ·åªæ‰“æ•£åˆ°å…¶å®ƒå…­ä¸ªå·¥ä½œæ—¥
jitter_u = sample(1:6, 1)
å‘¨å‘¨æœŸä¾ç„¶èƒ½åœ¨å›¾ä¸Šè‹¥éšè‹¥ç°åœ°çœ‹åˆ°ï¼ˆå› ä¸ºåç§»éƒ½æ˜¯ 1~6 å¤©ï¼‰ï¼Œä½†â€œ0 å¤©â€é‚£æ ¹å°–å³°è¢«ç§»èµ°äº†

```{r Overlay Jitter 2, warning=FALSE, message=FALSE}
# ä½¿ç”¨æ•´å‘¨æŠ–åŠ¨ï¼ˆæœ€å¤š 4 å‘¨ï¼‰ï¼‹ D å†…å°æŠ–åŠ¨
W = 4      # æœ€å¤š 4 å‘¨
d = 3      # å†åŠ  0â€“3 å¤©çš„å°æŠ–åŠ¨
sigma = 1  # å°æ­£æ€å™ªå£°ï¼ˆå¯é€‰ï¼‰

orders_weekly <- orders_rel %>%
  group_by(user_id) %>%
  mutate(
    # æ•´å‘¨åç§» + å°å¤©æ•°æŠ–åŠ¨
    jitter_u = 7 * sample(0:W,1) + sample(0:d,1),
    anchor_u   = cutoff_date - max(cum_days) - jitter_u,
    order_date = anchor_u + cum_days
  ) %>%
  ungroup()

orders_weekly %>%
  filter(cum_days>0) %>%
  count(order_date) %>%
  ggplot(aes(order_date,n)) +
    geom_line() +
    labs(
      title="Pseudo-calendar with Weekly-aligned Jitter",
      x="Order Date", y="Re-order Count"
    ) +
    theme_minimal()


```
---
é—®é¢˜åˆ†æ
1. ç¼ºå¤±ä¸æˆªæ–­æ¦‚å†µ
é¦–å…ˆç»Ÿè®¡åŸå§‹æ•°æ®ä¸­ä¸¤ç±»å…³é”®æƒ…å†µï¼š
  é¦–å• NA
  â€œâ‰¥30 å¤©â€æˆªæ–­
```{r Missingness situration, warning=FALSE, message=FALSE}
orders %>% 
  summarise(
    total      = n(),
    na_first   = sum(is.na(days_since_prior_order)),
    trunc30    = sum(days_since_prior_order == 30, na.rm = TRUE),
    prop_na    = na_first   / total,
    prop_trunc = trunc30    / total
  )

```


2. ç¼ºå¤±æœºåˆ¶åˆ¤å®š
æ ¹æ® Rubin å¯¹ç¼ºå¤±æœºåˆ¶çš„åˆ†ç±»ï¼š
  MCARï¼ˆå®Œå…¨éšæœºç¼ºå¤±ï¼‰ï¼šç¼ºå¤±ä¸ä»»ä½•æ•°æ®å€¼éƒ½æ— å…³
  MARï¼ˆæ¡ä»¶éšæœºç¼ºå¤±ï¼‰ï¼šç¼ºå¤±ä¸è§‚æµ‹åˆ°çš„å…¶ä»–å˜é‡æœ‰å…³
  MNARï¼ˆééšæœºç¼ºå¤±/Censoringï¼‰ï¼šç¼ºå¤±ï¼ˆæˆ–æˆªæ–­ï¼‰ä¸è‡ªèº«æœªè§‚æµ‹å€¼æœ‰å…³ 

åœ¨å·²æœ‰æ–¹æ¡ˆä¸­ï¼Œæˆ‘ä»¬åªæ˜¯æŠŠé¦–å• NA â†’ 0ï¼ŒæŠŠ `days_since_prior_order == 30` å½“ä½œæˆªæ–­å€¼ã€‚ä½†ä» Rubin çš„åˆ†ç±»æ¥çœ‹ï¼Œè¿™ä¸¤ç§ç¼ºå¤±æ˜¯æˆªç„¶ä¸åŒçš„ï¼š
  1. **é¦–å• NA** å±äº **MCARï¼ˆMissing Completely at Randomï¼‰**â€”â€”é¦–å•æ•°æ®/ä¸šåŠ¡é€»è¾‘ æœ¬èº«å°±ä¸å­˜åœ¨ï¼Œç›´æ¥å¡« 0 åˆç†ï¼Œä¸ä¼šå¼•å…¥ç³»ç»Ÿæ€§åå·®
  2. **30 å¤©æˆªæ–­** æ˜¯ä¸€ç§ **MNARï¼ˆMissing Not at Randomï¼‰/å—é™è§‚æµ‹ï¼ˆcensoringï¼‰** æƒ…å†µâ€”â€”ä»»ä½•è¶…è¿‡ 30 å¤©çš„çœŸå®é—´éš”éƒ½è¢«ç¡¬æ€§æŠ˜å åˆ° 30ï¼Œä¸”è¿™ç§æŠ˜å ä¸çœŸå®é—´éš”ï¼ˆç¼ºå¤±å€¼ï¼‰æœ¬èº«æœ‰å…³ 

3. ç¼ºå¤±æ¨¡å¼å¯è§†åŒ–
ä½¿ç”¨ mice å’Œ VIM åŒ…æ£€æŸ¥ç¼ºå¤±ä¸æˆªæ–­åœ¨å¤šå˜é‡ä¸­çš„åˆ†å¸ƒ,è¯„ä¼°â€œæˆªæ–­â€è®°å½•ä¸å…¶ä»–å­—æ®µï¼ˆé¢‘ç‡ã€æœ€åä¸€å•å‘¨å‡ /æ—¶æ®µï¼‰ä¹‹é—´çš„å…³è”ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨ MNAR é£é™©ï¼š

```{r Missingness Mechanism, warning=FALSE, message=FALSE}
library(mice)
library(VIM)

# ç¼ºå¤±æ¨¡å¼è¡¨
md.pattern(orders[, c("days_since_prior_order", "order_number", 
                             "order_dow", "order_hour_of_day")])

# æ•´ä½“ç¼ºå¤±ä¸æˆªæ–­å¯è§†åŒ–
aggr(orders[, c("days_since_prior_order", "order_number", 
                        "order_dow", "order_hour_of_day")],
     numbers = TRUE, prop = TRUE, sortVars = TRUE)

```
åªæœ‰ days_since_prior_order å­˜åœ¨ NA æˆ–æˆªæ–­ï¼Œå…¶ä»–å­—æ®µ (order_numberã€order_dowã€order_hour_of_day) å®Œæ•´æ— ç¼ºå¤±ï¼Œè¿™è¯´æ˜æˆ‘ä»¬ä¸éœ€è¦ä¸ºå…¶å®ƒåˆ—åšé¢å¤–æ’è¡¥ï¼Œä½† days_since_prior_order çš„æˆªæ–­å€¼å¾—é‡ç‚¹å…³æ³¨ã€‚


4. æ„é€ ç›¸å¯¹æ—¶é—´ï¼ˆcum_daysï¼‰ä¸ç”¨æˆ·æ±‡æ€»è¡¨
ç”¨ orders è¡¨å…ˆè®¡ç®—å‡ºæ¯ç¬”è®¢å•çš„ç´¯ç§¯å¤©æ•° cum_daysï¼Œå¹¶æ®æ­¤åœ¨åç»­æ­¥éª¤ä¸­æ›¿ä»£å¯¹ order_date çš„éœ€æ±‚ã€‚

```{r cum_days, warning=FALSE, message=FALSE}
orders_rel <- orders %>%
  arrange(user_id, order_number) %>%
  group_by(user_id) %>%
  mutate(
    days0    = replace_na(days_since_prior_order, 0),
    cum_days = cumsum(days0)
  ) %>%
  ungroup()

```


5. MNAR é£é™©åˆæ­¥å®šé‡æ£€éªŒ
æ€è·¯ï¼šåˆ¤æ–­å“ªäº› order è¢«æˆªæ–­ï¼ˆdays_since_prior_order == 30ï¼‰å¹¶æ‰“ä¸Šæˆªæ–­æ ‡è®°ï¼Œå†æŒ‰ç”¨æˆ·æ±‡æ€»ï¼Œæ£€éªŒâ€œæˆªæ–­æ¯”ä¾‹â€ä¸ç”¨æˆ·â€œé¢‘ç‡ï¼æ–°è¿‘åº¦â€æ˜¯å¦ç›¸å…³

```{r MNAR risk test, warning=FALSE, message=FALSE}
# 5.1 ç”¨æˆ·çº§èšåˆ
orders_user <- orders_rel %>%
  mutate(is_trunc = (days_since_prior_order == 30)) %>%
  group_by(user_id) %>%
  summarise(
    frequency    = max(order_number,        na.rm = TRUE),
    recency_days = max(cum_days,            na.rm = TRUE),  # ç”¨ cum_days æ›¿ä»£ order_date
    prop_trunc   = mean(is_trunc,           na.rm = TRUE)
  ) %>%
  ungroup()

# 5.2 ç›¸å…³æ€§æ£€éªŒ
cor_freq <- cor.test(orders_user$frequency,    orders_user$prop_trunc)
cor_recv <- cor.test(orders_user$recency_days, orders_user$prop_trunc)

list(cor_with_frequency    = cor_freq,
     cor_with_recency_days = cor_recv)

```
ä¸ºæ¯ä¸ªç”¨æˆ·è®¡ç®—â€œæˆªæ–­æ¯”ä¾‹â€ (prop_trunc)ï¼Œå³ä¸€ä½ç”¨æˆ·å¤šå°‘ç¬”è®¢å•è¢«æ ‡è®°ä¸º 30 å¤©
ä¸ä¸¤å¤§æ ¸å¿ƒè¡Œä¸ºæŒ‡æ ‡åšçš®å°”é€Šç›¸å…³æ£€éªŒï¼š
  ä¸é¢‘ç‡ï¼ˆfrequencyï¼‰ç›¸å…³ï¼šr â‰ˆ â€“0.455ï¼Œp < 2.2eâ€“16
  ä¸æ–°è¿‘åº¦ï¼ˆrecency_daysï¼‰ç›¸å…³ï¼šr â‰ˆ â€“0.264ï¼Œp < 2.2eâ€“16

è¿™ä¸¤æ¡è´Ÿç›¸å…³è¡¨æ˜ï¼š
  ä¸‹å•è¶Šå¤šçš„ç”¨æˆ·ï¼Œå…¶â€œæˆªæ–­â€è®°å½•åè€Œè¶Šå°‘ï¼›
  è·é¦–å•æ—¶é—´è¶Šé•¿çš„ç”¨æˆ·ï¼Œè¢«æˆªæ–­çš„æ¯”ä¾‹ä¹Ÿç•¥ä½ã€‚

æ¢è¨€ä¹‹ï¼Œâ€œæˆªæ–­â€å¹¶ééšæœºå‘ç”Ÿï¼Œè€Œæ˜¯ä¸ç”¨æˆ·è¡Œä¸ºå¯†åˆ‡ç›¸å…³ï¼Œå±äº MNARï¼ˆMissing Not At Randomï¼‰ã€‚


å°ç»“ï¼š
  é¦–å• NAï¼šå¯å®‰å…¨å¡« 0ã€‚
  â‰¥ 30 å¤©æˆªæ–­ï¼šä¸ç”¨æˆ·è¡Œä¸ºï¼ˆé¢‘ç‡ã€æ–°è¿‘åº¦ï¼‰æ˜¾è‘—ç›¸å…³ï¼Œä¸èƒ½ç®€å•å½“åšçœŸå® 30 å¤©æˆ–éšæœºå¡«å……ï¼Œéœ€ç”¨å¤šé‡æ’è¡¥ç­‰æ–¹æ³•æ¥å°Šé‡è¿™ä¸€ä¸ç¡®å®šæ€§ã€‚

---
åŸºäºè¿™ä¸€ MNAR å‘ç°ï¼Œå¯¹â€œæˆªæ–­å€¼â€åšåˆç†çš„å¤šé‡æ’è¡¥ï¼ˆMultiple Imputationï¼‰ç¡®ä¿å¯¹æˆªæ–­å€¼çš„å¤„ç†æ—¢ä¸å¤±åå·®ï¼Œåˆèƒ½é‡åŒ–ä¸ç¡®å®šæ€§

å¤šé‡æ’è¡¥ï¼ˆMIï¼‰æ¦‚å¿µå›é¡¾ï¼ŒRubin çš„å¤šé‡æ’è¡¥ï¼ˆMIï¼‰æµç¨‹æœ‰ **ä¸‰æ­¥**ï¼šæ’è¡¥â†’åˆ†æâ†’åˆå¹¶ 
1. **Imputationï¼ˆæ’è¡¥ï¼‰**ï¼šå¯¹æ¯ä¸ªç¼ºå¤±å€¼ç”Ÿæˆ m ä»½æ’è¡¥ï¼ˆmâ‰ˆç¼ºå¤±ç™¾åˆ†æ¯”ï¼‰
   - **æ¨¡å‹é€‰æ‹©**ï¼šé’ˆå¯¹ `days_since_prior_order` è¶…è¿‡ 30 çš„é‚£äº›â€œæˆªæ–­â€å€¼ï¼Œæ„å»ºé¢„æµ‹æ¨¡å‹ã€‚å€™é€‰ç®—æ³•åŒ…æ‹¬ï¼š
     - **Predictive Mean Matching (PMM)**ï¼šç”Ÿæˆä¸è§‚æµ‹æ•°æ®åˆ†å¸ƒåŒ¹é…çš„çœŸå®é—´éš”å€¼ï¼Œé¿å…æ’è¡¥å‡ºä¸åˆç†çš„â€œå¤§æ•°å€¼â€ 
     - **Stochastic Regression Imputation**ï¼šåœ¨çº¿æ€§æ¨¡å‹é¢„æµ‹å€¼ä¸ŠåŠ å™ªå£°ï¼Œä¿ç•™ä¸ç¡®å®šæ€§ã€‚
   - **å¤šå˜é‡å…±æ’è¡¥**ï¼šåˆ©ç”¨ç”¨æˆ·çš„ `order_dow`ã€`order_hour_of_day`ã€`frequency`ã€`recency_days`ã€ç¯®å­å¤§å°ç­‰ä½œä¸ºåå˜é‡ï¼Œé€šè¿‡ MICEï¼ˆIterative Chained Equationsï¼‰ä¸€æ¬¡æ€§å¯¹æ‰€æœ‰å«ç¼ºå¤±çš„å˜é‡ï¼ˆè¿™é‡Œä¸»è¦æ˜¯é‚£äº›è¢«æˆªæ–­çš„é—´éš”ï¼‰åšæ’è¡¥
   - **ç”Ÿæˆ m ä¸ªæ•°æ®é›†**ï¼ˆmâ‰ˆç¼ºå¤±æ¯”ä¾‹ç™¾åˆ†æ¯”ï¼Œä¾‹å¦‚ 30%â†’m=30ï¼‰ï¼Œä¿ç•™æ’è¡¥å·®å¼‚åº¦
2. **Analysisï¼ˆåˆ†æï¼‰**ï¼šåœ¨æ¯ä¸ªæ’è¡¥æ•°æ®é›†ä¸Šåˆ†åˆ«è®¡ç®—æ‰€éœ€ç»Ÿè®¡é‡æˆ–æ¨¡å‹
   - é’ˆå¯¹æ¯ä¸ªæ’è¡¥å®Œçš„æ•°æ®é›†ï¼Œé‡å¤åŸæ¥çš„â€œä¼ªæ—¥å†é‡å»º + ç‰¹å¾å·¥ç¨‹â€æµç¨‹ï¼Œå¾—åˆ° m ç»„ `order_date`ã€`cum_days`ã€RFM ç­‰ç‰¹å¾
3. **Poolingï¼ˆåˆå¹¶ï¼‰**ï¼šåˆ©ç”¨ Rubinâ€™s Rules åˆå¹¶ m ä¸ªç»“æœï¼Œè®¡ç®—æ€»ä½“ä¼°è®¡å€¼ä¸æ€»æ–¹å·®
   - æŒ‰ç…§ **Rubinâ€™s Rules** åˆå¹¶ä¸‹æ¸¸æ¨¡å‹çš„å‚æ•°å’Œæ–¹å·®ä¼°è®¡ï¼Œæ—¢åˆ©ç”¨äº†æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œåˆæ­£ç¡®åæ˜ äº†æ’è¡¥å¸¦æ¥çš„ä¸ç¡®å®šæ€§ 

1. æ•°æ®å‡†å¤‡
```{r Data preparation for MI, warning=FALSE, message=FALSE}
# åœ¨åŸå§‹ orders_rel ä¸­ï¼Œå°†æ‰€æœ‰ days_since_prior_order == 30 è§†ä¸ºâ€œç¼ºå¤±â€ï¼Œå¹¶ä¿ç•™ä¸€åˆ—æ ‡è®°
imp_data <- orders_rel %>%
  mutate(
    days_imp    = ifelse(days_since_prior_order == 30, NA, days_since_prior_order),
    is_trunc    = (days_since_prior_order == 30)
  ) %>%
  # é€‰æ‹©ç”¨äºæ’è¡¥çš„å˜é‡ï¼šdays_impï¼ˆå¾…æ’è¡¥ï¼‰ã€order_numberã€order_dowã€order_hour_of_dayã€cum_daysã€is_trunc
  select(user_id, order_number, order_dow, order_hour_of_day, cum_days, is_trunc, days_imp)

```


2. å¤šé‡æ’è¡¥è®¾ç½®
  2.1 ç”Ÿæˆé¢„æµ‹çŸ©é˜µï¼šç¡®ä¿ days_imp ç”±å…¶ä»–åˆ—é¢„æµ‹ï¼Œä½†ä¸è‡ªæˆ‘é¢„æµ‹
  2.2 æŒ‡å®šæ’è¡¥æ–¹æ³•ï¼šå¯¹ days_imp ä½¿ç”¨ PMM
  2.3 é€‰æ‹©æ’è¡¥ä»½æ•° ğ‘šï¼šæŒ‰â€œç¼ºå¤±æ¯”ä¾‹â€çš„ç»éªŒæ³•åˆ™ï¼Œè®¾ ğ‘š â‰ˆ 10ï¼ˆå¤§çº¦ç­‰äº 10.8%ï¼‰

**ä»¥ä¸‹è¿™æ®µæ²¡ä¼˜åŒ–è¿‡ï¼Œå¤ªè€—æ—¶ï¼Œä¸è·‘**
```{r MI settings, warning=FALSE, message=FALSE}
# 2.1 æ„é€  predictorMatrix
predM <- make.predictorMatrix(imp_data)
predM["days_imp", "days_imp"] <- 0
# è®© is_trunc ä¹Ÿä½œä¸ºåå˜é‡ï¼Œå¸®åŠ©æ¨¡å‹è¯†åˆ«æˆªæ–­è¡Œä¸º
predM["days_imp", "is_trunc"] <- 1

# 2.2 æŒ‡å®šæ–¹æ³•ï¼šåªå¯¹ days_imp ç”¨ PMMï¼Œå…¶ä»–å˜é‡ä¸æ’è¡¥
meth <- make.method(imp_data)
meth[] <- ""             # å…ˆæ¸…ç©ºæ‰€æœ‰
meth["days_imp"] <- "pmm"

# 2.3 æ‰§è¡Œå¤šé‡æ’è¡¥
set.seed(2025)
imp <- mice(
  data           = imp_data,
  m              = 10,    # ç”Ÿæˆ 10 ä¸ªæ’è¡¥æ•°æ®é›†
  method         = meth,
  predictorMatrix= predM,
  maxit          = 20     # è¿­ä»£ 20 æ¬¡ä»¥ç¡®ä¿æ”¶æ•›
)


```

2.4 MICE åœ¨é»˜è®¤é…ç½®ä¸‹ä¼šå¯¹æˆ‘ä»¬æ ‡è®°ä¸ºç¼ºå¤±ï¼ˆdays_imp == NAï¼Œçº¦ 37 ä¸‡æ¡è®°å½•ï¼‰çš„é‚£ä¸€åˆ—ï¼š
  2.4.1.ç”Ÿæˆ ğ‘š=10 ä»½ï¼ˆm = 10ï¼‰å®Œæ•´æ•°æ®é›†
  2.4.2.æ¯ä»½æ•°æ®è¿­ä»£ maxit = 20 æ¬¡ï¼Œæ¯æ¬¡éƒ½è¦å¯¹æ‰€æœ‰ç¼ºå¤±å€¼åšä¸€æ¬¡ Predictive Mean Matching æ’è¡¥
      æ‰€ä»¥æ€»å…±è¦åš 10Ã—20=200è½®â€œæŒ–è¡¥å…¨è¡¨â€æ“ä½œâ€”â€”æ•°æ®é‡çº§æ˜¯ 37Â ä¸‡ä¸ªç¼ºå¤±å€¼ Ã— 200 â‰ˆ 7.4 Ã— 10çš„7æ¬¡æ–¹ï¼Œæ¬¡æ’è¡¥åŠ ä¸Šæ¯æ¬¡æ’è¡¥éƒ½è¦ä»æ•°åä¸‡ä¸ªè§‚æµ‹ä¸­æŒ‘â€œæœ€ç›¸è¿‘çš„â€å‡ ä¸ªæ ·æœ¬ï¼Œä¼šéå¸¸éå¸¸è€—æ—¶ã€‚

2.5 åŠ é€Ÿï¼ä¼˜åŒ–ç­–ç•¥ï¼š
  2.5.1. å‡å°‘ m å’Œ maxitï¼š
    m æ’è¡¥ä»½æ•°ä¸å¿…å¤ªå¤§ï¼Œå¸¸ç”¨ 5â€“7 å³å¯
    maxit ä¸€èˆ¬ 5â€“10 æ¬¡å°±è¶³å¤Ÿæ”¶æ•›
  2.5.2. ç²¾ç®€é¢„æµ‹çŸ©é˜µï¼ˆpredictorMatrixï¼‰ï¼š
    åªç”¨æœ€é‡è¦çš„åå˜é‡æ¥é¢„æµ‹ days_impï¼Œæ¯”å¦‚åªä¿ç•™ order_numberã€cum_daysï¼Œå»æ‰ order_dowã€order_hour_of_dayã€‚
  2.5.3. å¹¶è¡Œè¿ç®—
    ä½¿ç”¨ future ä¸ mice çš„å¹¶è¡Œæ¥å£ï¼Œä¸€æ¬¡å¹¶è¡Œè·‘å¤šä¸ªæ’è¡¥ï¼ˆmice 3.13+ æ”¯æŒï¼‰
  2.5.4. é™ä½ç²’åº¦
    å¦‚æœåç»­åªéœ€è¦ â€œæ¯ä¸ªç”¨æˆ·ä¸€è¡Œâ€ çš„ç‰¹å¾ï¼ˆæ¯”å¦‚ recency_daysã€frequencyï¼‰ï¼Œå¯ä»¥å…ˆ æŒ‰ç”¨æˆ·èšåˆï¼Œåªå¯¹èšåˆåçš„è¡¨åšæ’è¡¥ï¼Œç¼ºå¤±æ¡æ•°å°±å¤§å¹…å‡å°‘ã€‚
    
ä»¥ä¸‹ä¸º 1-3 çš„åŠ é€Ÿï¼ä¼˜åŒ– **[è¿˜æ˜¯å¤ªè´¹æ—¶äº†ï¼Œä¸è·‘]**
```{r MI_Optimized_1, warning=FALSE, message=FALSE}
# å¹¶è¡Œè®¾ç½®ï¼šæ ¹æ®ä½ æœºå™¨çš„æ ¸æ•°è°ƒæ•´ workers
plan(multicore, workers = 4)

# â€”â€”â€” 1. é‡æ„ imp_data â€”â€”â€”
imp_data <- orders_rel %>%
  mutate(
    days_imp = ifelse(days_since_prior_order == 30, NA, days_since_prior_order),
    is_trunc = (days_since_prior_order == 30)
  ) %>%
  select(user_id, order_number, cum_days, is_trunc, days_imp)

# â€”â€”â€” 2. æ„é€ æ›´ç²¾ç®€çš„ predictorMatrix â€”â€”â€”
predM <- make.predictorMatrix(imp_data)
# ä¸è®© days_imp è‡ªå·±é¢„æµ‹è‡ªå·±ï¼Œä¹Ÿä¸è¦ç”¨ user_id
predM["days_imp", c("days_imp", "user_id")] <- 0
# åªä¿ç•™è¿™ä¸‰åˆ—åšé¢„æµ‹ï¼šorder_number, cum_days, is_trunc
keep <- c("order_number", "cum_days", "is_trunc")
predM["days_imp", setdiff(names(imp_data), c(keep, "days_imp"))] <- 0

# â€”â€”â€” 3. æŒ‡å®šæ’è¡¥æ–¹æ³• â€”â€”â€”
meth <- make.method(imp_data)
meth[] <- ""              # æ¸…ç©ºæ‰€æœ‰é»˜è®¤æ–¹æ³•
meth["days_imp"] <- "pmm" # ä»…ç”¨ PMM æ’è¡¥ days_imp

# â€”â€”â€” 4. æ‰§è¡Œå¤šé‡æ’è¡¥ â€”â€”â€”
set.seed(2025)
imp_opt <- mice(
  data            = imp_data,
  m               = 5,             # æ’è¡¥ä»½æ•°é™åˆ° 5
  method          = meth,
  predictorMatrix = predM,
  maxit           = 10,            # è¿­ä»£æ¬¡æ•°é™åˆ° 10
  seed            = 2025,
  parallel        = "multicore"    # å¹¶è¡Œæ¨¡å¼
)

# æŸ¥çœ‹æ”¶æ•›è¯Šæ–­
plot(imp_opt, c("days_imp"))
```

ä»¥ä¸‹ä¸º é™ä½ç²’åº¦ çš„åŠ é€Ÿï¼ä¼˜åŒ– **[è·‘è¿™æ®µ]**
```{r MI_Optimized_2, warning=FALSE, message=FALSE}
# å¹¶è¡Œè®¾ç½® â€” Parallel settings â€”
## Windows / RStudio (use multisession)
n_workers_windows <- parallel::detectCores(logical = FALSE) - 1
plan(multisession, workers = n_workers_windows)

## Linux / WSL / macOS (use multicore; uncomment if on non-Windows)
# n_workers_linux <- parallel::detectCores(logical = TRUE) - 1
# plan(multicore, workers = n_workers_linux)

# 1. æŒ‰ user çº§èšåˆï¼Œæ³¨æ„ na.rm = TRUE 
# Aggregate to user level with na.rm = TRUE
user_imp <- orders_rel %>%
  group_by(user_id) %>%
  summarise(
    # å…ˆç”¨ na.rm = TRUE æ±‚ maxï¼Œå†åˆ¤æ–­æˆªæ–­
    max_days    = max(days_since_prior_order, na.rm = TRUE),
    days_imp    = ifelse(max_days == 30, NA, max_days),
    frequency   = max(order_number,      na.rm = TRUE)
  ) %>%
  select(-max_days) %>%
  ungroup()

# ç¡®è®¤é NA çš„ days_imp è¿˜æœ‰å¤šå°‘
#Confirm how many nonâ€NA days_imp remain
table(is.na(user_imp$days_imp))

# 2. æ„é€  predictorMatrixï¼šdays_imp â† frequency
pm_user <- matrix(
  c(0, 1,   # days_imp predicted by frequency
    0, 0),  # frequency ä¸æ’è¡¥
  ncol = 2, byrow = TRUE,
  dimnames = list(c("days_imp", "frequency"),
                  c("days_imp", "frequency"))
)

# 3. æŒ‡å®šæ–¹æ³• Specify methods: only pmm for days_imp
meth_user <- c("pmm", "")  # åªæ’è¡¥ days_imp

# 4. æ‰§è¡Œ MI
set.seed(2025)
imp_user <- mice(
  data            = user_imp,
  m               = 5,
  method          = meth_user,
  predictorMatrix = pm_user,
  maxit           = 10,
  seed            = 2025,
  parallel        = "multicore"
)

# 5. å¯é€‰ï¼šæ£€æŸ¥æ”¶æ•›
plot(imp_user, "days_imp")
```
2.6 ç»“æœåˆ†æ
  2.6.1. table(is.na(user_imp$days_imp)):
    æ€»ç”¨æˆ·æ•°ï¼š54197 + 152012 = 206 209ã€‚
    FALSE (54 197)ï¼šè¿™éƒ¨åˆ†ç”¨æˆ·åœ¨èšåˆåæœ‰çœŸå®çš„æœ€å¤§é—´éš”ï¼ˆå³ä»–ä»¬ max(days_since_prior_order) < 30ï¼‰ï¼Œä¸éœ€è¦æ’è¡¥ã€‚
    TRUE (152 012)ï¼šè¿™éƒ¨åˆ†ç”¨æˆ·çš„æœ€å¤§é—´éš”åŸæœ¬ç­‰äº 30ï¼Œè¢«æˆ‘ä»¬æ ‡è®°ä¸º NAï¼Œéœ€è¦ç”± MICE å»æ’è¡¥ã€‚

  2.6.2. MICE æ’è¡¥æ—¥å¿—ï¼ˆiter imp variableï¼‰:
    iterï¼šå½“å‰ç¬¬å‡ æ¬¡è¿­ä»£ï¼ˆæ€»å…± maxit = 10ï¼‰ã€‚
    impï¼šå½“å‰é’ˆå¯¹ç¬¬å‡ ä¸ªæ’è¡¥é“¾ï¼ˆæ€»å…± m = 5ï¼‰åœ¨è¿è¡Œã€‚
    variableï¼šè¦æ’è¡¥çš„å˜é‡ (days_imp)ã€‚
    ä¹Ÿå°±æ˜¯è¯´ï¼ŒMICE ä¼šå¯¹æ¯æ¡é“¾ï¼ˆchainï¼‰åšä¸€æ¬¡â€œPMM æ’è¡¥â€”â€”æ›´æ–°ç¼ºå¤±çš„ days_impâ€ï¼Œç„¶åè¿­ä»£å¤šæ¬¡ï¼ˆè¿™é‡Œå…± 10 æ¬¡ï¼‰ã€‚

  2.6.3. æ”¶æ•›è¯Šæ–­å›¾ï¼ˆplot(imp_user, "days_imp")ï¼‰
    (å·¦ï¼šæ’è¡¥å€¼çš„å¹³å‡æ•°ï¼›å³ï¼šæ’è¡¥å€¼çš„æ ‡å‡†å·®)
    æ¯æ¡å½©è‰²çº¿ï¼šè¡¨ç¤ºä¸€æ¡â€œæ’è¡¥é“¾â€åœ¨å„æ¬¡è¿­ä»£ä¸­ï¼Œæ’è¡¥å‡ºæ¥çš„ days_imp å€¼çš„å¹³å‡æ•°ï¼ˆå·¦å›¾ï¼‰æˆ–æ ‡å‡†å·®ï¼ˆå³å›¾ï¼‰ã€‚
    æ¨ªè½´ï¼šè¿­ä»£æ¬¡æ•° 1â†’10ï¼›çºµè½´ï¼šæ’è¡¥å€¼çš„ç»Ÿè®¡é‡ï¼ˆmean æˆ– sdï¼‰ã€‚
    æ”¶æ•›åˆ¤å®šï¼šå¦‚æœå‡ æ¡é“¾çš„æ›²çº¿åœ¨å‡ æ¬¡è¿­ä»£åéƒ½â€œçº ç¼ åˆ°ä¸€å—â€å¹¶åœ¨æŸä¸ªæ°´å¹³çº¿ä¸Šå·¦å³æ³¢åŠ¨ï¼Œå°±è¯´æ˜ PMM ç®—æ³•å·²ç»è¶‹äºç¨³å®šã€ä¸å†å¤§å¹…è·³åŠ¨ã€‚
    å›¾é‡Œï¼ŒMean å¤§çº¦åœ¨ 20 é™„è¿‘ã€SD åœ¨ 6â€“7 é™„è¿‘å¾˜å¾Šï¼›ä»è¿­ä»£ 4â€“5 å¼€å§‹ï¼Œå„é“¾çš„è½¨è¿¹éƒ½æ²¡å‡ºç°æ˜æ˜¾çš„â€œä¸‹å±±â€æˆ–â€œä¸Šå‡â€è¶‹åŠ¿ï¼Œè¯´æ˜å·²ç»æ”¶æ•›ã€‚

  2.6.4.å°ç»“:
    ç¼ºå¤±åˆ†å¸ƒï¼šçº¦ 74%ï¼ˆ152 012/206 209ï¼‰çš„ç”¨æˆ·éœ€è¦æ’è¡¥ï¼Œ25% æœ‰çœŸå®è§‚æµ‹ã€‚
    æ’è¡¥æµç¨‹ï¼šMICE åœ¨ 5 æ¡é“¾ä¸Šè·‘äº† 10 æ¬¡è¿­ä»£ï¼Œæ¯æ¬¡éƒ½æ›´æ–°ä¸€æ¬¡ days_impã€‚
    æ”¶æ•›æƒ…å†µï¼šä»è¯Šæ–­å›¾çœ‹ï¼Œå„é“¾åœ¨ç¬¬ 4ã€5 æ¬¡å·¦å³å°±ç¨³å®šä¸‹æ¥äº†ï¼Œm=5, maxit=10 çš„è®¾ç½®æ˜¯è¶³å¤Ÿçš„


3. æ’è¡¥åç‰¹å¾é‡å»º
å¯¹æ¯ä¸ªæ’è¡¥ç‰ˆæœ¬ï¼Œæ¢å¤ days_since_prior_orderï¼Œå¹¶æŒ‰åŸæµç¨‹é‡å»º cum_daysã€order_date ç­‰ç‰¹å¾
3.1 å¯¹äºMI ä½¿ç”¨äº† è®¢å•çº§ MI  [1-3 æ­¥éª¤]ï¼Œé€‰ç”¨ä¸‹é¢çš„ä»£ç ä»¥å®Œæ•´æ¢å¤ `cum_days`ã€`order_date`ï¼Œå¯è§†åŒ–æ›´çµæ´»ï¼Œä½†è€—æ—¶æ›´é•¿
```{r Feature reconstruction orderLevel, warning=FALSE, message=FALSE}
# 3.1 æ‹¿åˆ°æ‰€æœ‰æ’è¡¥åçš„å®Œæ•´è®¢å•çº§æ•°æ®é›†
completed_orders <- complete(imp_opt, "all")  # æˆ–è€… complete(imp, "all")

# 3.2 é’ˆå¯¹æ¯ä¸ªæ’è¡¥ç‰ˆæœ¬é‡å»º cum_daysã€order_date
orders_reconstructed <- map_dfr(
  seq_along(completed_orders),
  function(i) {
    completed_orders[[i]] %>%
      # æŠŠ days_imp é‡å‘½åå› days_since_prior_order
      rename(days_since_prior_order = days_imp) %>%
      arrange(user_id, order_number) %>%
      group_by(user_id) %>%
      mutate(
        days0    = replace_na(days_since_prior_order, 0),
        cum_days = cumsum(days0),
        # å¦‚æœéœ€è¦ä¼ªæ—¥å†ï¼š
        # anchor_date = cutoff_date - max(cum_days),
        # order_date  = anchor_date + cum_days
      ) %>%
      ungroup() %>%
      mutate(imputation = i)
  }
)

# ç¤ºèŒƒæŸ¥çœ‹ç¬¬ä¸€ä¸ª imputation çš„å‰å‡ è¡Œ
orders_reconstructed %>% filter(imputation == 1) %>% slice_head(n = 10) %>% print()

```

3.2 å¯¹äºMI ä½¿ç”¨äº† ç”¨æˆ·çº§ MI  [ç”¨æˆ·ç²’åº¦èšåˆ æ­¥éª¤4]ï¼Œé€‰ç”¨ä¸‹é¢çš„ä»£ç ä»¥å®Œæ•´æ¢å¤ `cum_days`ã€`order_date`ï¼Œå¯è§†åŒ–æ›´çµæ´»ï¼Œä½†è€—æ—¶æ›´é•¿
```{r Feature reconstruction userLevel, warning=FALSE, message=FALSE}
# 3.1 æ‹¿åˆ°æ‰€æœ‰æ’è¡¥åçš„ userâ€level æ•°æ®é›†
completed_list <- complete(imp_user, "all")

# 3.2 å¯¹æ¯ä¸ªæ’è¡¥ç‰ˆæœ¬ï¼Œç”Ÿæˆç”¨æˆ·çº§ç‰¹å¾è¡¨
user_features_mi <- map_dfr(
  seq_along(completed_list),
  function(i) {
    completed_list[[i]] %>%
      rename(
        # days_imp å°±æ˜¯ â€œæœ€åä¸€æ¬¡ä¸‹å•é—´éš”â€
        recency_days = days_imp
      ) %>%
      mutate(
        # frequency å·²ç»åœ¨èšåˆæ—¶è®¡ç®—è¿‡
        imputation = i
      ) %>%
      select(user_id, recency_days, frequency, imputation)
  }
)

# çœ‹ä¸€ä¸‹å‰å‡ è¡Œ
user_features_mi %>% group_by(imputation) %>% slice_head(n = 5) %>% print()
```

è¿™æ ·å°±å¾—åˆ°äº†ä¸€ä¸ª **(user_id, recency_days, frequency, imputation)** çš„é•¿è¡¨ï¼Œå¯ä»¥ç”¨äºåç»­æ¨¡å‹è®­ç»ƒæ—¶å¯¹ä¸ç¡®å®šæ€§è¿›è¡Œé‡åŒ–

4.éªŒè¯ MI åçš„æ’è¡¥è´¨é‡
4.1 æ£€æŸ¥åŸå§‹ vs æ’è¡¥å€¼çš„åˆ†å¸ƒ
4.2 æŸ¥çœ‹æ¯æ¡æ’è¡¥é“¾çš„è½¨è¿¹ï¼ˆæ”¶æ•› vs ä¸æ”¶æ•›ï¼‰
4.3 å¯¹æœ€ç»ˆç‰¹å¾ï¼ˆrecency_daysï¼‰åœ¨ä¸åŒ imputation ä¹‹é—´åšå¯¹æ¯”


é€šè¿‡ä»¥ä¸‹ä¸‰æ–¹é¢çš„æ£€æŸ¥ï¼Œå¯ä»¥å¯¹ MI åçš„æ•°æ®è´¨é‡æœ‰è¾ƒä¸ºå…¨é¢çš„ç†è§£ï¼Œç¡®å®šæ˜¯å¦éœ€è¦è°ƒæ•´ `m`ã€`maxit`ã€`predictorMatrix` æˆ–æ’è¡¥æ–¹æ³•

# 1. MICE å†…ç½®è¯Šæ–­ï¼šè§‚å¯Ÿæ’è¡¥é“¾ (days_imp) çš„åˆ†å¸ƒæ”¶æ•›æƒ…å†µ, å¯†åº¦å›¾ & æ¡çŠ¶å›¾ å¯ä»¥ç›´è§‚å¯¹æ¯”ï¼šå„æ¡é“¾æ˜¯å¦åœ¨ç±»ä¼¼èŒƒå›´å†…æ’è¡¥ï¼Œæ˜¯å¦æ”¶æ•›
   - å¦‚æœå„æ¡é“¾ï¼ˆé¢œè‰²ä¸åŒçš„çº¿æˆ–ä¸åŒ .imp å€¼ï¼‰åœ¨å¤§è‡´åŒä¸€åŒºé—´èšæ‹¢ï¼Œä¸”å¯†åº¦æ›²çº¿å½¢çŠ¶ç›¸ä¼¼ï¼Œè¯´æ˜æ’è¡¥æ¨¡å‹ç¨³å®šã€æ”¶æ•›è‰¯å¥½ã€‚  
   - å¦‚æœæœ‰æŸä¸€æ¡é“¾ä¸å…¶å®ƒé“¾æ˜æ˜¾åˆ†ç¦»ï¼Œæˆ–æ›²çº¿ç›¸å·®å¾ˆå¤§ï¼Œè¯´æ˜å¯èƒ½éœ€è¦å¢åŠ  `maxit` æˆ–æ£€æŸ¥ predictorMatrixã€‚
   
```{r MI_Diagnostics_1a, warning=FALSE, message=FALSE}
# 1a) å¯†åº¦å›¾ï¼šå„é“¾æœ€ç»ˆæ’è¡¥å€¼åˆ†å¸ƒ
densityplot(imp_user, ~ days_imp, main = "Density of Imputed days_imp by Chain")

```
1.a Density of Imputed days_imp by Chain
æ¯ä¸€æ¡å½©è‰²æ›²çº¿ä»£è¡¨ä¸€æ¡æ’è¡¥é“¾ï¼ˆimp = 1â€¦5ï¼‰å¯¹æ‰€æœ‰éœ€è¦æ’è¡¥çš„ days_imp å€¼åšå‡ºçš„â€œè¾¹é™…â€åˆ†å¸ƒ
ç†æƒ³æƒ…å†µï¼šå„æ¡æ›²çº¿éƒ½åœ¨åŒä¸€ä¸ªå¤šå³°å½¢çŠ¶ä¸Šæ¥å›ï¼ˆå³°çš„ä½ç½®ç›¸åŒã€ç›¸å¯¹é«˜åº¦ç›¸ä¼¼ï¼‰ï¼Œè¯´æ˜æ— è®ºå“ªæ¡é“¾ï¼Œæœ€ç»ˆæ’è¡¥å‡ºçš„å€¼éƒ½éµå¾ªåŒä¸€åˆ†å¸ƒï¼Œæ’è¡¥è¿‡ç¨‹å·²æ”¶æ•›

è¯¥å›¾ï¼š
- å¯ä»¥çœ‹åˆ°ä¸€ç³»åˆ—åœ¨ 1â€“29 å¤©ä¹‹é—´çš„å¤šé‡å³°â”€â”€å¯¹åº”ç”¨æˆ·å¸¸è§çš„å¤è´­é—´éš”ï¼ˆå¦‚ 14ã€21ã€28 å¤©ç­‰ï¼‰åªæ˜¯é«˜åº¦å’Œè½®å»“ç•¥æœ‰å·®å¼‚
- è™½ç„¶æœ‰å°‘æ•°é“¾åœ¨ â€œ4 å¤©â€å¤„å‡ºç°ä¸€ä¸ªå°å³°ï¼Œè¿™å¾€å¾€æ˜¯ç”±äºåŸå§‹æ•°æ®é‡Œç¡®å®å­˜åœ¨ä¸€äº› 4 å¤©é—´éš”çš„è®¢å•ï¼ˆè™½ç„¶ä¸é‚£ä¹ˆæ˜¾çœ¼ï¼‰ï¼ŒPMM å°†å®ƒä»¬å½“ä½œå€™é€‰â€œè¿‘é‚»â€æ¥æ’è¡¥
- å„é“¾çš„å³°ä½å¤§ä½“ä¸€è‡´ï¼ˆæ¯”å¦‚éƒ½åœ¨ 7ã€14ã€21ã€28 å¤©å‡ºç°é«˜å¯†åº¦ï¼‰ï¼Œè™½ç„¶é«˜åº¦ç•¥æœ‰å·®åˆ«ï¼Œä½†å³°çš„ä½ç½®å¯¹é½ï¼Œè¯´æ˜é“¾å·²æ”¶æ•›åˆ°åŒä¸€å¤šå³°åˆ†å¸ƒä¸Š

ç»“è®ºï¼šæ’è¡¥é“¾åˆ†å¸ƒä¸€è‡´æ€§è‰¯å¥½ï¼ŒPMM æ²¡è·‘å‡ºå¥‡å¼‚æ¨¡å¼ã€‚


```{r MI_Diagnostics_1b, warning=FALSE, message=FALSE}
# 1b) æ¡çŠ¶å›¾ (stripplot)ï¼šå„æ¡é“¾åœ¨æ¯æ¬¡è¿­ä»£çš„æ’è¡¥å€¼åˆ†å¸ƒ
stripplot(imp_user, days_imp ~ .imp, vertical = TRUE,
          pch = 20, cex = 1.2,
          main = "Stripplot of days_imp by Imputation")

```
1.b Stripplot of days_imp by Imputation
æ¨ªåæ ‡æ˜¯æ’è¡¥ç¼–å· 1â€“5ï¼Œçºµåæ ‡æ˜¯æ¯æ¡æ’è¡¥ç”Ÿæˆçš„ days_imp å€¼ã€‚çº¢è‰²ç‚¹ä»£è¡¨â€œè¢«æ’è¡¥â€çš„å€¼ï¼ˆåŸå…ˆçš„ 30 è¢«æ ‡è®°ä¸º NAï¼‰ï¼Œè“è‰²ç‚¹ä»£è¡¨åŸæœ¬å°±è§‚æµ‹åˆ°çš„çœŸå®å€¼ï¼ˆå› æˆ‘ä»¬æŠŠå®ƒä»¬ä¹Ÿç•™åœ¨ long format ä¸­ä¸€èµ·ç”»äº†ï¼‰
ç†æƒ³æƒ…å†µï¼šæ¯ä¸ªæ’è¡¥ç¼–å·ä¸‹çš„çº¢ç‚¹ï¼ˆæ’è¡¥å€¼ï¼‰åº”å¤§è‡´å †åœ¨åŒä¸€å‚ç›´å¸¦ï¼Œåˆ†å¸ƒä¸å…¶å®ƒç¼–å·ç›¸ä¼¼ï¼Œä¸”ä¸»è¦è¦†ç›–é‚£äº›è§‚æµ‹ä¸åˆ°çš„é«˜é—´éš”åŒºæ®µ

è¯¥å›¾ï¼š
- çº¢ç‚¹ï¼ˆæ’è¡¥ï¼‰ä¸»è¦è½åœ¨ 1â€“29 èŒƒå›´ï¼Œä¸è“ç‚¹å…±å­˜ï¼Œå¹¶æ²¡æœ‰æˆç‰‡åœ°è·‘åˆ°æŸä¸ªç¦»è°±åŒºé—´ï¼Œä¸”å„ç»„æ¨ªå‘é«˜åº¦å’Œå¯†åº¦ç›¸ä»¿
- è™½ç„¶å¶æœ‰å°‘æ•°æ’è¡¥é“¾æ’å‡ºçš„æç«¯ç‚¹ç•¥å¤šï¼Œä½†æ•´ä½“çœ‹ï¼Œ5 ç»„æ’è¡¥éƒ½åœ¨ç±»ä¼¼åŒºé—´éšæœºåˆ†å¸ƒ
- é‚£ä¸ªæ’è¡¥ç¼–å· 5 åœ¨ 4 å¤©å¤„å¤šå‡ ä¸ªçº¢ç‚¹ï¼Œæ˜¯æ­£å¸¸çš„ä¸ªåˆ«å·®å¼‚â€”â€”åªè¦å¤§å¤šæ•°çº¢ç‚¹éƒ½è½åœ¨åˆç†åŒºé—´ï¼Œä¸”ä¸ä¸åŒæ’è¡¥çš„çº¢ç‚¹åˆ†å¸ƒç›¸ä¼¼ï¼Œå°±è¯´æ˜ PMM æ’è¡¥è¡Œä¸ºä¸€è‡´

ç»“è®ºï¼šæ’è¡¥å€¼åœ¨å„æ¬¡æ’è¡¥ä¸­å¹¶æœªâ€œé£˜â€åˆ°å®Œå…¨ä¸åŒçš„åŒºé—´ï¼Œè¿è´¯æ€§è‰¯å¥½




# 2. æ¯”è¾ƒ Observed vs Imputed values
   - åŸå§‹è§‚æµ‹ (`.imp == 0`) ä¸æ‰€æœ‰æ’è¡¥å€¼ (`.imp > 0`) åº”è¯¥æ€»ä½“åˆ†å¸ƒç›¸è¿‘ä½†ä¸å®Œå…¨é‡åˆã€‚  
   - å¦‚æœæ’è¡¥å€¼æ˜¾è‘—åç¦»åŸå§‹è§‚æµ‹ï¼ˆä¾‹å¦‚æ’è¡¥éƒ½é›†ä¸­åœ¨ä¸€ä¸ªå°åŒºé—´ï¼‰ï¼Œè¯´æ˜æ¨¡å‹å¯èƒ½æ¬ æ‹Ÿåˆæˆ– predictorMatrix å¤ªç®€å•ã€‚

```{r MI_Diagnostics_2, warning=FALSE, message=FALSE}
# 2a) æŠŠ imp_user å±•å¼€æˆé•¿æ ¼å¼
long_imp <- complete(imp_user, "long", include = TRUE)

# 2b) æ ‡è®°â€œobservedâ€(åŸå§‹) vs â€œimputedâ€
long_imp <- long_imp %>%
  mutate(type = ifelse(.imp == 0, "observed", "imputed"))

# 2c) ç”» density æ¯”è¾ƒ
ggplot(long_imp, aes(x = days_imp, fill = type)) +
  geom_density(alpha = 0.3) +
  labs(title = "Observed vs Imputed days_imp Distribution",
       x = "days_imp", fill = "")

```
2.c Observed vs Imputed days_imp Distribution
é’è‰² (observed)ï¼šåŸå§‹ days_impï¼ˆå³çœŸå® <30 çš„é‚£éƒ¨åˆ†ï¼‰åˆ†å¸ƒ
ç²‰è‰² (imputed)ï¼šæ’è¡¥å‡ºæ¥çš„å€¼åˆ†å¸ƒã€‚
åˆç†çš„æ’è¡¥åº”å½“â€œå¡«è¡¥â€ è§‚æµ‹ç¨€ç–çš„åŒºé—´ï¼ˆåœ¨åŸæœ¬é’è‰²ç¨€ç–çš„åŒºé—´ï¼Œä¾‹å¦‚ 10â€“12ï¼Œ16-20ï¼Œ23-26 å¤©åŒºé—´ï¼Œå¸¦æ¥æ›´å¤šå¯†åº¦ï¼‰ï¼ŒåŒæ—¶ä¿ç•™æ€»ä½“å¤šå³°ç»“æ„ï¼ˆåœ¨ä¸»è¦è§‚æµ‹å³°å‘¨å›´å»¶å±•ï¼‰

è¯¥å›¾ï¼š
- çœ‹åˆ°é’è‰²åœ¨ 0â€“30 å¤©åŒºé—´æœ‰å¥½å‡ æ®µé«˜å³°ï¼ˆçœŸå®æ•°æ®åå¥½åœ¨æŸå‡ å¤©å¤è´­ï¼‰
- ç²‰è‰²åˆ™åœ¨è¿™äº›å³°å‘¨å›´ä¹Ÿå‡ºç°å¯¹åº”é¢‘æ¬¡ï¼Œå¹¶åœ¨æŸäº›é’è‰²ç©ºç™½åŒºï¼ˆæ¯”å¦‚ 8 å¤©å·¦å³ï¼‰å¢åŠ äº†å°å³°â”€â”€è¿™æ­£æ˜¯ PMM ä»ç›¸ä¼¼è§‚æµ‹ä¸­åŒ¹é…å‡ºæ¥çš„ç»“æœ
- åœ¨ 4 å¤©ç­‰æ¬¡è¦åŒºé—´å‡ºç°å°å³°ï¼Œåªè¦å®ƒä¸æ˜¯è¿‡åº¦ä¸»å¯¼åˆ†å¸ƒï¼Œå°±ä¸å¿…æ‹…å¿ƒ

ç»“è®ºï¼šæ’è¡¥åˆ†å¸ƒç¬¦åˆé¢„æœŸï¼Œæ—¢ä¸ç¡¬è´´åœ¨åŸå§‹é’è‰²åˆ†å¸ƒä¸Šï¼Œä¹Ÿæ²¡è·‘åˆ°è’å”åŒºé—´



# 3. æ¯”è¾ƒ recency_days åœ¨å„ imputation ä¹‹é—´çš„ä¸€è‡´æ€§
   - æŸ¥çœ‹ `mean_recency`ã€`sd_recency` åœ¨å„ä¸ª imputation ä¹‹é—´çš„å·®å¼‚ï¼Œå¦‚æœå·®å¼‚å¾ˆå°ï¼ˆå°äºä¸šåŠ¡å¯æ¥å—èŒƒå›´ï¼‰ï¼Œè¯´æ˜ MI ä¸ç¡®å®šæ€§è¾ƒä½
   - Density/boxplot å¯ä»¥ç›´è§‚å¯¹æ¯”åˆ†ä½å’Œå°¾éƒ¨å·®å¼‚
   
```{r MI_Diagnostics_3a, warning=FALSE, message=FALSE}
# 3a) æ±‡æ€» user_features_mi
mi_stats <- user_features_mi %>%
  group_by(imputation) %>%
  summarise(
    mean_recency   = mean(recency_days),
    sd_recency     = sd(recency_days),
    median_recency = median(recency_days),
    min_recency    = min(recency_days),
    max_recency    = max(recency_days),
    .groups = "drop"
  )

print(mi_stats)

```
è§£è¯»ï¼š
mean_recencyï¼šæ¯æ¬¡æ’è¡¥è®¡ç®—å‡ºçš„å…¨ä½“ç”¨æˆ· recency_days çš„å¹³å‡å€¼ã€‚
sd_recencyï¼šå…¶æ ‡å‡†å·®ï¼Œè¡¡é‡æ’è¡¥ååˆ†å¸ƒçš„ç¦»æ•£ç¨‹åº¦ã€‚
median_recencyã€min_recencyã€max_recencyï¼šåˆ†åˆ«æ˜¯ä¸­ä½æ•°ã€æœ€å°å€¼å’Œæœ€å¤§å€¼ã€‚

å¯ä»¥æ³¨æ„åˆ°ï¼Œæ¯æ¬¡æ’è¡¥çš„ mean_recency åœ¨ ~16â€“23 å¤©ä¹‹é—´å˜åŠ¨ï¼Œsd_recency åœ¨ ~4â€“8 å¤©ä¹‹é—´ã€‚è¿™åæ˜ äº†å¤šé‡æ’è¡¥å¸¦æ¥çš„ä¸ç¡®å®šæ€§ï¼šæˆ‘ä»¬å¹¶ä¸åªæ˜¯å¡«ä¸€ä¸ªå›ºå®šå€¼ï¼Œè€Œæ˜¯åœ¨åˆç†åŒºé—´å†…ç”Ÿæˆå¤šç§å¯èƒ½ï¼Œæ–¹ä¾¿åç»­åœ¨æ¨¡å‹æˆ–æŠ¥å‘Šä¸­é‡åŒ–è¿™éƒ¨åˆ†ä¸ç¡®å®šæ€§ã€‚


```{r MI_Diagnostics_3b, warning=FALSE, message=FALSE}
# 3b) å¯è§†åŒ–å„ imputation çš„ recency åˆ†å¸ƒ
ggplot(user_features_mi, aes(x = recency_days, color = factor(imputation))) +
  geom_density() +
  labs(title = "Recency_days Density by Imputation",
       x = "recency_days", color = "imp #") +
  theme_minimal()

```


```{r MI_Diagnostics_3c, warning=FALSE, message=FALSE}
# 3c) æˆ–è€… boxplot
ggplot(user_features_mi, aes(x = factor(imputation), y = recency_days)) +
  geom_boxplot() +
  labs(title = "Recency_days Boxplot by Imputation",
       x = "Imputation", y = "recency_days") +
  theme_minimal()
```
è¿™ä¸¤å¼ å›¾å¯¹æ¯”äº†æ¯æ¬¡æ’è¡¥åã€ç”¨æˆ·çº§ç‰¹å¾ recency_daysï¼ˆæœ€åä¸€æ¬¡é—´éš”ï¼‰çš„å·®å¼‚
- Densityï¼šäº”æ¡å½©çº¿è¡¨ç¤ºäº”æ¬¡æ’è¡¥çš„å¯†åº¦æ›²çº¿ã€‚å®ƒä»¬è™½ç„¶å³°ä½ç½®å’Œé«˜åº¦ç•¥æœ‰åç§»ï¼ˆæ¯”å¦‚ç¬¬ 3 æ¬¡å³°æ›´å¤šé›†ä¸­åœ¨ 15â€“17 å¤©ï¼Œç¬¬ 2 æ¬¡åœ¨ ~23 å¤©ï¼‰ï¼Œä½†æ€»ä½“èŒƒå›´ä¸€è‡´ã€‚
- Boxplotï¼šå±•ç¤ºæ¯æ¬¡æ’è¡¥çš„ä¸­ä½æ•°ï¼ˆç›’å­ä¸­çº¿ï¼‰ã€å››åˆ†ä½è·ï¼ˆç›’å­é«˜åº¦ï¼‰åŠç¦»ç¾¤ç‚¹ã€‚å¯ä»¥çœ‹åˆ°ï¼š
    ä¸­ä½æ•°åœ¨ 13â€“24 å¤©æµ®åŠ¨
    IQRï¼ˆç›’å­ï¼‰å¤§çº¦åœ¨ 15â€“25 å¤©å·¦å³

ç»“è®ºï¼šæ’è¡¥å¸¦æ¥äº†å¤§çº¦ Â±4 å¤©çš„å…¨å±€å‡å€¼æ³¢åŠ¨å’Œ Â±2â€“3 å¤©çš„å››åˆ†ä½è·å˜åŒ–ï¼Œä½†æ²¡æœ‰å‡ºç°æŸæ¬¡æ’è¡¥å®Œå…¨è„±ç¦»å…¶ä»–å››æ¬¡çš„æƒ…å†µã€‚



æ€»ä½“è¯„ä»·
- è™½ç„¶çœ‹ä¸Šå»â€œç¬¬ 3 æ¬¡â€å’Œâ€œç¬¬ 4 æ¬¡â€æ’è¡¥çš„å‡å€¼åä½ï¼ˆ~16 å¤©ï¼‰ï¼Œâ€œç¬¬ 2 æ¬¡â€åé«˜ï¼ˆ~23 å¤©ï¼‰ï¼Œä½†è¿™ç§ Â±4â€“6 å¤©çš„æ³¢åŠ¨æ­£æ˜¯ MI å¸Œæœ›ä¿ç•™çš„â€œæ’è¡¥ä¸ç¡®å®šæ€§â€ã€‚
- æ²¡æœ‰ä»»ä½•ä¸€æ¡æ’è¡¥é“¾æˆ–ä¸€æ¬¡æ’è¡¥çš„åˆ†å¸ƒå½»åº•è·‘ååˆ° 0â€“5 å¤©æˆ– 25â€“30 å¤©åŒºé—´ä¹‹å¤–ï¼Œè¯´æ˜æ²¡æœ‰é‡å€¼æˆ–æ¨¡å¼å´©åã€‚
- å› æ­¤ï¼Œå½“å‰ MI ç»“æœæ˜¯åˆæ ¼ä¸”å¯ç”¨çš„ã€‚è‹¥ä»æ‹…å¿ƒæ³¢åŠ¨èŒƒå›´ï¼Œå¯ä»¥ï¼š
    a. å¢å¤§ mï¼ˆä» 5 â†’ 7 æˆ– 10ï¼‰ï¼Œè®©æ³¢åŠ¨ä¼°è®¡æ›´ç¨³å®šï¼›
    b. åŠ å…¥æ›´å¤šåå˜é‡ï¼ˆå¦‚ order_dowï¼‰åˆ° predictorMatrix ä¸­ï¼Œæå‡æ’è¡¥ç²¾åº¦ï¼›
    c. åˆ‡åˆ†ç”¨æˆ·ç¾¤ï¼ˆé«˜é¢‘ vs ä½é¢‘ï¼‰åˆ†åˆ«æ’è¡¥ï¼Œä»¥æ•æ‰ä¸åŒè¡Œä¸ºæ¨¡å¼ã€‚

---
ç›‘æ§ä¸å‘Šè­¦
1. ç›‘æ§ç¼ºå¤± / æˆªæ–­æ¯”ä¾‹
- ç¼ºå¤±æ¯”ä¾‹ï¼šæŒ‡åœ¨æ¯æ‰¹æ¬¡ï¼ˆæˆ–æ¯å¤©ã€æ¯å‘¨ï¼‰çš„ orders è¡¨é‡Œï¼Œdays_since_prior_order ä¸º NAï¼ˆé¦–å•ï¼‰çš„è¡Œæ•°å æ€»è¡Œæ•°çš„æ¯”é‡ã€‚
- æˆªæ–­æ¯”ä¾‹ï¼šæŒ‡è¯¥å­—æ®µæ°å¥½ç­‰äº 30 å¤©ï¼ˆå³è¢«ç¡¬æˆªæ–­ï¼‰çš„è®¢å•æ•°å æ€»è¡Œæ•°çš„æ¯”é‡ã€‚

2. ä¸ºä»€ä¹ˆè¦è®¾ç½®ç›‘æ§
- æ•°æ®è´¨é‡é¢„è­¦ï¼šå¦‚æœæœ‰ä¸€å¤©ç¼ºå¤±æ¯”ä¾‹çªç„¶ä» ~6% é£™é«˜åˆ° 20%ï¼Œè¯´æ˜ ETL å¯èƒ½å‡ºäº†é—®é¢˜ï¼ˆå­—æ®µæ²¡è¢«æ­£ç¡®å¡« 0ï¼‰ï¼›
- ä¸šåŠ¡æ¨¡å¼å˜åŠ¨ï¼šæˆªæ–­æ¯”ä¾‹çªç„¶å‡é«˜ï¼Œå¯èƒ½åå°æŠŠé˜ˆå€¼ä» 30 æ”¹æˆåˆ«çš„æ•°ï¼Œæˆ–å®¢æˆ·è¡Œä¸ºå‡ºç°å‰§å˜ï¼Œéœ€è¦æ ¸å®ã€‚
- æ¨¡å‹å¥å£®æ€§robustnessï¼šæˆªæ–­åˆ†å¸ƒä¸€æ—¦å¤§å¹…å˜åŒ–ï¼Œå¯¹æ’è¡¥åŠæ¨¡å‹é¢„æµ‹éƒ½ä¼šäº§ç”Ÿå½±å“ï¼ŒåŠæ—¶å‘ç°èƒ½åŠæ—¶å›æ»šæˆ–é‡æ–°è®­ç»ƒã€‚

3. æ‰‹æ®µ
1. åœ¨ Athena é‡Œå»ºä¸€ä¸ªå®šæœŸè·‘çš„è§†å›¾æˆ–è¡¨

2. åœ¨ QuickSight æˆ– Athena æ§åˆ¶å°å»ºä¸€ä¸ª Time-series å›¾è¡¨
  - æŠŠ missing_cnt/total_cnt å’Œ trunc_cnt/total_cnt å½“ä½œä¸¤æ¡æŠ˜çº¿ç›‘æ§
  - è®¾ç½®é˜ˆå€¼å‘Šè­¦ï¼šä¾‹å¦‚å½“æŸæ—¥ä»»ä¸€æ¯”ä¾‹è¶…è¿‡ 15%ï¼Œé‚®ä»¶/Slack æé†’æˆ‘ä»¬

---
æ•æ„Ÿæ€§åˆ†æä¸æŠ¥å‘Š

1. MNAR æƒ…å¢ƒæ¨¡æ‹Ÿï¼ˆBest/Worstâ€caseï¼‰
ç›®æ ‡ï¼šè¯„ä¼°â€œæˆªæ–­ä¸º 30 å¤©â€è¿™ä¸€å‡è®¾å¯¹ç‰¹å¾å’Œæ¨¡å‹ç»“æœçš„å½±å“

1.1 Bestâ€case & Worstâ€case åœºæ™¯
Bestâ€caseï¼ˆæœ€ä¹è§‚ï¼‰ï¼šå‡å®šæ‰€æœ‰è¢«æˆªæ–­çš„é—´éš”éƒ½æ°å¥½æ˜¯é˜ˆå€¼ï¼ˆ30 å¤©ï¼‰
Worstâ€caseï¼ˆæœ€æ‚²è§‚ï¼‰ï¼šå‡å®šæ‰€æœ‰è¢«æˆªæ–­çš„å®é™…é—´éš”éƒ½è¿œå¤§äºé˜ˆå€¼ï¼ˆä¾‹å¦‚ 60 å¤©æˆ– 90 å¤©ï¼‰

1.2 ä»£ç 
```{r Best_Worst_case, warning=FALSE, message=FALSE}
# å…ˆå®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼šç»™å®š days_scï¼ˆæ’è¡¥æˆ–å‡è®¾åçš„é—´éš”ï¼‰é‡ç®—ç”¨æˆ·çº§ cum_days & recency_days
recalc_features <- function(df) {
  df %>%
    arrange(user_id, order_number) %>%
    group_by(user_id) %>%
    mutate(cum_days = cumsum(days_sc)) %>%
    summarise(recency_days = max(cum_days), .groups="drop")
}

# Best-caseï¼šä¿ç•™ 30 å¤©æˆªæ–­
orders_best <- orders_rel %>%
  mutate(days_sc = replace_na(days_since_prior_order, 0))  # NAâ†’0, 30 ä¿æŒ 30

# Worst-caseï¼šæŠŠæ‰€æœ‰ 30 å¤©æˆªæ–­å€¼ç»Ÿä¸€å½“ä½œ 60 å¤©
orders_worst <- orders_rel %>%
  mutate(days_sc = replace_na(days_since_prior_order, 0),
         days_sc = if_else(days_sc == 30, 60, days_sc))

# é‡ç®—ç‰¹å¾å¹¶æ‰“æ ‡ç­¾
feat_best  <- recalc_features(orders_best)  %>% mutate(scenario = "best")
feat_worst <- recalc_features(orders_worst) %>% mutate(scenario = "worst")

# åˆå¹¶
feat_bw <- bind_rows(feat_best, feat_worst)

# å¯è§†åŒ– recency_days çš„åˆ†å¸ƒ
ggplot(feat_bw, aes(x = recency_days, fill = scenario)) +
  geom_density(alpha = 0.3) +
  labs(
    title = "Sensitivity: Best vs Worst",
    x     = "Recency Days",
    fill  = "Scenario"
  ) +
  theme_minimal()

```
è¿™å¼ â€œBest vs Worstâ€æ•æ„Ÿæ€§å¯†åº¦å¯¹æ¯”å›¾æ¸…æ™°åœ°å±•ç¤ºäº†åœ¨ä¸¤ç§æç«¯å‡è®¾ä¸‹ï¼Œç”¨æˆ·æœ€åä¸€æ¬¡ä¸‹å•è·é¦–å•ï¼ˆrecency_daysï¼‰çš„åˆ†å¸ƒæœ‰å¤šä¹ˆæˆªç„¶ä¸åŒ

1. ç²‰è‰²ï¼ˆBestâ€caseï¼‰æ›²çº¿
å‡è®¾ï¼šæ‰€æœ‰åŸæœ¬è¢«æˆªæ–­ä¸º 30 å¤©çš„é—´éš”ï¼Œå°±éƒ½çœŸçš„åªæœ‰ 30 å¤©
åˆ†å¸ƒç‰¹ç‚¹ï¼š
  - ä¸»å³°é›†ä¸­åœ¨è¾ƒä½çš„ recency_days å€¼ï¼ˆå¤§çº¦åœ¨ 50â€“120 å¤©åŒºé—´å†…ï¼Œå…·ä½“å³°å€¼å–å†³äºæ•°æ®ï¼‰
      æœ€é«˜ç‚¹å¤§çº¦è½åœ¨ 60â€“80 å¤©ï¼Œè¯´æ˜å¦‚æœæ‰€æœ‰ â€œâ‰¥30 å¤©â€ éƒ½å½“æˆ 30 å¤©ï¼Œé‚£ä¹ˆå¤šæ•°ç”¨æˆ·ä»é¦–å•åˆ°æœ€åä¸€å•çš„é—´éš”åœ¨ä¸¤ä¸‰ä¸ªæœˆå†…å®Œæˆ
  - ä¸»å³°çš„å³ä¾§éšçº¦å¯ä»¥çœ‹åˆ°å‡ ä¸ªå°å³°ï¼Œé—´éš”å¤§çº¦ 20â€“30 å¤©ï¼Œåæ˜ äº† 7 å¤©å‘¨å‘¨æœŸçš„å åŠ æ•ˆåº”
  - 350 é™„è¿‘æœ‰æ¬¡å³°ï¼Œä½†å°äºWorstâ€case çš„æ›²çº¿
  - é•¿å°¾å³°åœ¨ ~350 å¤©å¤„ é‚£ä¸ªå³ä¾§çš„å°–å³°ä¼°è®¡æ˜¯å¯¹åº”é‚£äº›è®¢å•æ•°ç‰¹åˆ«å¤šçš„ç”¨æˆ·ï¼Œä»–ä»¬å³ä½¿æ¯æ¬¡éƒ½æŒ‰ 30 å¤©ç®—ï¼Œä¹Ÿç´¯ç§¯åˆ°è¿‘ä¸€å¹´æ‰å®Œæˆæ‰€æœ‰è®¢å•

2. é’ç»¿è‰²ï¼ˆWorstâ€caseï¼‰æ›²çº¿
å‡è®¾ï¼šæ‰€æœ‰è¢«æˆªæ–­çš„é—´éš”éƒ½å®é™…æ˜¯ 60 å¤© ï¼ˆå°†æˆªæ–­çš„ 30 å¤©éƒ½å½“ä½œ 60 å¤©ï¼‰
åˆ†å¸ƒç‰¹ç‚¹:
  - ä¸»å³°å³ç§»åˆ°æ›´å¤§çš„ recency_days å€¼ï¼ˆå¤§çº¦åœ¨ 350â€“400 å¤©åŒºé—´ï¼‰è¯´æ˜å¦‚æœæ¯æ¬¡â€œâ‰¥30 å¤©â€éƒ½è®°ä½œ 60 å¤©ï¼Œç»å¤§å¤šæ•°ç”¨æˆ·çœ‹èµ·æ¥è¿‘ä¸€å¹´æ‰å®Œæˆä»–ä»¬çš„æœ€åä¸€å•
  - åœ¨ 150â€“300 å¤©ä¹‹é—´æœ‰å‡ ä¸ªå°å³°ï¼Œå¯¹åº”é‚£äº›åªæœ‰å°‘æ•°å‡ æ¬¡â€œè¶…é•¿â€é—´éš”çš„ç”¨æˆ·ï¼ˆå¦‚ç¬¬ 2ã€3 å•å‡ºç°ä¸€æ¬¡ 60 å¤©åï¼Œç¬¬ 3ã€4 å•åˆæ˜¯å¸¸è§„ 7 å¤©å·¦å³ï¼‰

3. å¯¹æ¯”ä¸å¯ç¤º
3.1 å³°å€¼ä½ç½®å½»åº•ä¸åŒ
  - Best_caseï¼šä¸»å³°åœ¨ ~80 å¤©ï¼›Worstâ€caseï¼šä¸»å³°åœ¨ ~400 å¤©ï¼Œå·¦å³å·®å¼‚è¾¾æ•°ç™¾å¤©ã€‚

3.2 å‘¨å‘¨æœŸæ³¢åŠ¨ä»ä¿ç•™
  - è™½ç„¶åœ¨ Worst_case ä¸‹ï¼Œå¤è´­çš„å‘¨å‘¨æœŸï¼ˆ7 å¤©å€æ•°ï¼‰ç•¸å˜å¾—ä¸é‚£ä¹ˆæ˜æ˜¾ï¼Œä½†ä»å¯åœ¨ä¸­æ®µå°å³°ä¸­çœ‹åˆ°çº¦ 20â€“30 å¤©ã€90 å¤©ç­‰è§„å¾‹

3.3 ä¸šåŠ¡è§£è¯»
  - å¦‚æœå®é™…ç”¨æˆ·ç¡®å®åœ¨å¾ˆå¤šè®¢å•é‡Œå‡ºç°äº† 30 å¤©ä»¥ä¸Šçš„é•¿é—´éš”ï¼Œé‚£ä¹ˆæŠŠå®ƒä»¬å½“æˆ 30 å¤©ä½ä¼°äº†æµå¤±æœŸï¼›åä¹‹å…¨éƒ¨å½“æˆ 60 å¤©åˆå¯èƒ½é«˜ä¼°
  - è¿™æç¤ºæˆ‘ä»¬ï¼Œå•ä¸€æˆªæ–­å‡è®¾å¯¹ recency_days çš„å½±å“æå¤§ï¼Œéœ€è¦ç”¨å¤šé‡æ’è¡¥æˆ–çµæ´»åˆ†ç®±æ¥å‡ç¼“è¿™ç§åå·®

3.4 æ”¹è¿›
  - è€ƒè™‘åˆ†å±‚æˆªæ–­ï¼šå¯¹é«˜é¢‘ç”¨æˆ·ï¼ˆfrequency é«˜ï¼‰çš„æˆªæ–­å€¼è®¾å°ä¸€äº›ï¼ˆå¦‚ 30ï¼‰ï¼Œå¯¹ä½é¢‘ç”¨æˆ·è®¾å¤§ä¸€äº›ï¼ˆå¦‚ 60ï¼‰ï¼Œä»¥æ›´è´´è¿‘ä¸åŒç”¨æˆ·çš„çœŸå®è¡Œä¸º
  - åœ¨æ¨¡å‹é‡Œé‡‡ç”¨åˆ†ç®±ç‰¹å¾ï¼šæŠŠ recency_days ç¦»æ•£åˆ°â€œ<60 å¤©â€ã€â€œ61â€“180 å¤©â€ã€â€œ>180 å¤©â€è¿™ç±»åˆ†ç®±ï¼Œå‡å°‘å¯¹å…·ä½“æ•°å€¼çš„æ•æ„Ÿåº¦
  - ä¿ç•™æ’è¡¥ä¸ç¡®å®šæ€§ï¼šåˆ©ç”¨ MI åå¾—åˆ°çš„å¤šå¥— recency_daysï¼Œåœ¨æ¨¡å‹é¢„æµ‹æ—¶è¾“å‡ºåŒºé—´é¢„æµ‹è€Œéç‚¹é¢„æµ‹ï¼Œä¸ºå†³ç­–æä¾›å¯é çš„å¯ä¿¡åŒºé—´
  
---
2. Deltaâ€adjustment
ç›®æ ‡ï¼šæµ‹è¯•â€œæˆªæ–­çœŸå®å€¼æ¯” 30 å¤©å¤šäº›æˆ–å°‘äº›â€å¯¹æ¨¡å‹çš„å½±å“ã€‚
é€šè¿‡æŸ¥çœ‹ mean_recencyã€median_recency éš delta å˜åŒ–çš„æ›²çº¿æ–œç‡ï¼Œè¯„ä¼°å¯¹ç‰¹å¾çš„æ•æ„Ÿåº¦
```{r Delta_adjustment, warning=FALSE, message=FALSE}
# å®šä¹‰åŒä¸€ä¸ª recalc_features å‡½æ•°ï¼ˆåŒBest_Worst_caseï¼Œå¦‚æœè¿˜æ²¡å®šä¹‰ï¼‰
# # å®šä¹‰ä¸€ç³»åˆ— Deltaï¼Œè¡¨ç¤ºç»™æˆªæ–­å€¼åŠ ä¸Šçš„åç§»
deltas <- c(-5, 0, 5, 15)   # æ¯”å¦‚ï¼š-5, 0, +5, +15 å¤©

# å¯¹æ¯ä¸ª delta ç”Ÿæˆä¸€ä¸ªåœºæ™¯
feat_delta <- map_dfr(deltas, function(d) {
  orders_rel %>%
    mutate(
      days_sc = replace_na(days_since_prior_order, 0),
      days_sc = if_else(days_sc == 30, days_sc + d, days_sc),
      days_sc = pmax(days_sc, 0)   # é˜²æ­¢è´Ÿå€¼
    ) %>%
    recalc_features() %>%
    mutate(delta = d)
})

# è®¡ç®—æ¯ä¸ª delta ä¸‹çš„ç»Ÿè®¡é‡
delta_stats <- feat_delta %>%
  group_by(delta) %>%
  summarise(
    mean_rec    = mean(recency_days),
    median_rec  = median(recency_days),
    p25         = quantile(recency_days, 0.25),
    p75         = quantile(recency_days, 0.75),
    .groups     = "drop"
  )

# ç»˜åˆ¶ Mean & Median & IQR éš delta å˜åŒ–
ggplot(delta_stats, aes(x = delta)) +
  geom_line(aes(y = mean_rec,    color = "Mean"),    size = 1) +
  geom_point(aes(y = mean_rec,   color = "Mean"),    size = 2) +
  geom_line(aes(y = median_rec,  color = "Median"),  linetype = "dashed", size = 1) +
  geom_point(aes(y = median_rec, color = "Median"),  shape = 17, size = 2) +
  geom_ribbon(aes(ymin = p25, ymax = p75), fill = "grey70", alpha = 0.4) +
  labs(
    title = "Delta-adjustment Sensitivity",
    x     = "Delta applied to truncated values",
    y     = "Recency Days",
    color = ""
  ) +
  scale_color_manual(values = c("Mean" = "blue", "Median" = "red")) +
  theme_minimal()

```

1. Meanï¼ˆå®çº¿ï¼Œè“è‰²ï¼‰å‘ˆçº¿æ€§ä¸Šç§»
  - å½“ Î” ä» âˆ’5 â†’ 0 â†’ 5 â†’ 15 æ—¶ï¼Œå¹³å‡ recency_days å¤§è‡´ä¹Ÿä» ~165 â†’ ~175 â†’ ~185 â†’ ~200çº¿æ€§ä¸Šå‡
  - è¿™è¯´æ˜å¯¹æ‰€æœ‰â€œ30 å¤©â€å€¼åŠ  Î”ï¼Œæ•´ä½“å¹³å‡ä¼šè¢«æ‹‰é«˜ Î” å¤©å·¦å³ï¼ˆç•¥æœ‰å¾®å°åå·®ï¼Œä½†éå¸¸æ¥è¿‘ä¸€å¯¹ä¸€å…³ç³»ï¼‰

2. Medianï¼ˆè™šçº¿ï¼Œçº¢è‰²ï¼‰åŒæ ·å‘ˆçº¿æ€§ä¸Šç§»
  - ä¸­ä½æ•°ä» ~140 â†’ ~150 â†’ ~160 â†’ ~185 å·¦å³éš Î” ä¸Šç§»ã€‚
  - å’Œå¹³å‡ç±»ä¼¼ï¼Œåªä¸è¿‡å› ä¸ºä¸­ä½æ•°å¯¹æç«¯å€¼ä¸æ•æ„Ÿï¼Œå®ƒçš„ä¸Šå‡å¹…åº¦æœ‰æ—¶ä¼šç¨å°æˆ–ç¨å¤§äº Î”ï¼Œä½†æ€»ä½“ä»æ˜¯å•è°ƒã€è¿‘çº¿æ€§çš„

3. IQRï¼ˆç°è‰²å¸¦ï¼‰ç°è‰²é˜´å½±å¸¦ä»£è¡¨å„ä¸ª Î” ä¸‹ 25%â€“75% åˆ†ä½ç‚¹ çš„åŒºé—´ï¼Œå¤§è‡´ä¿æŒå¸¸å®½ï¼Œæ•´ä½“ä¸Šç§»
  - å½“ Î” æ”¹å˜æ—¶ï¼Œé˜´å½±å¸¦æ•´ä½“ å¾€ä¸Šå¹³ç§»
  - å¸¦çš„ é«˜åº¦ï¼ˆå®½åº¦ï¼‰å‡ ä¹æ²¡å˜ï¼Œè¯´æ˜åˆ†ä½è·ï¼ˆIQRï¼‰ä¿æŒç¨³å®šï¼Œåˆ†å¸ƒå½¢çŠ¶æœªè¢«æ‰­æ›²

å°ç»“ï¼š
1. å¯æ§çš„å¹³ç§»ï¼šåªè¦ç»™æˆªæ–­å€¼åŠ  Î”ï¼Œrecency_days çš„é›†ä¸­è¶‹åŠ¿å°±ä¼šç¨³å¥åœ°ã€å‡ ä¹ç­‰é‡ä¸Šç§»ï¼Œä¾¿äºåšå‚æ•°æ ¡å‡†æˆ–ä¸šåŠ¡å¯¹é½
2. åˆ†å¸ƒå½¢çŠ¶ä¸å˜ï¼šIQR ä¿æŒè¿‘ä¹æ’å®šï¼Œè¡¨ç¤ºæ— è®ºæ€ä¹ˆå‡è®¾ï¼Œç”¨æˆ·ç¾¤çš„å†…éƒ¨åˆ†å¸ƒâ€œå®½åº¦â€ï¼â€œç¦»æ•£åº¦â€éƒ½å·®ä¸å¤šï¼Œæ¨¡å‹ä¸­å¯¹ç›¸å¯¹é¡ºåºçš„åˆ¤æ–­ä¸ä¼šä¹±
3. è¿™å¼ å›¾å±•ç¤ºäº†å¯¹â€œæˆªæ–­å€¼å‡è®¾â€çš„å®Œå…¨å¯æ§æ•æ„Ÿåº¦ï¼šï¼ˆå¯¹äºåç»­çš„æ¨¡å‹æ ¡å‡†ã€é˜ˆå€¼è®¾ç½®ï¼‰åªè¦ Î” è°ƒæ•´é‡ç»™å®šï¼ŒRecency çš„ä¸­å¿ƒä½ç½®ï¼ˆMean/Medianï¼‰å°±è·Ÿç€ç›´çº¿çº§ä¸Šç§»ï¼Œè€Œåˆ†å¸ƒå®½åº¦ä¿æŒç¨³å®š



---

3. æŠ¥å‘Šé€æ˜æŠ«éœ²
åœ¨æŠ¥å‘Šæˆ– Confluence æ–‡æ¡£ä¸­ï¼ŒåŠ¡å¿…è¦å†™æ˜ï¼š
1. å“ªäº›å­—æ®µä¸ºä»€ä¹ˆè¦æ’è¡¥ï¼ˆæ­¤å¤„ï¼šdays_since_prior_order == 30 å±äº MNAR æˆªæ–­ï¼‰
2. ä½¿ç”¨çš„æ’è¡¥æ–¹æ³•ä¸å‚æ•°
  - æ–¹æ³•ï¼šPredictive Mean Matching
  - m å€¼ï¼š5 ï¼ˆåç»­å¯ä»¥æµ‹è¯• 7æˆ–10ï¼‰
  - maxitï¼š10
  - åå˜é‡ï¼šfrequency ç­‰

å¦‚ä½•æ£€éªŒ MNARï¼ˆå‰é¢åšè¿‡çš„ç›¸å…³æ€§æ£€éªŒå’Œå¯è§†åŒ–è¯´æ˜ï¼‰

æ•æ„Ÿæ€§æµ‹è¯•

Best/Worstâ€case å’Œ Deltaâ€adjustment çš„æµç¨‹ä¸ä¸»è¦ç»“è®º

â€œå¦‚æœå‡è®¾æ”¹å˜ï¼Œæ¨¡å‹è¾“å‡ºå¦‚ä½•â€

---
5. ç›¸å…³æ€§ä¸èšç±»
```{r corrplot, warning=FALSE, message=FALSE}
# ç›¸å…³æ€§çŸ©é˜µ
num_df <- orders %>% select_if(is.numeric)
corr_mat <- cor(num_df, use="pairwise.complete.obs") # è®¡ç®—æ¯ä¸€å¯¹æ•°å€¼åˆ—çš„çš®å°”é€Šç›¸å…³ç³»æ•°ï¼Œè‡ªåŠ¨è·³è¿‡ç¼ºå¤±å€¼ã€‚ç»“æœæ˜¯ä¸€ä¸ª 5Ã—5 çš„å¯¹ç§°çŸ©é˜µï¼Œå…ƒç´ å€¼åœ¨ â€“1 åˆ° +1 ä¹‹é—´
corrplot::corrplot(corr_mat, method="ellipse") # ç”¨æ¤­åœ†çš„å½¢çŠ¶å’Œé¢œè‰²æ·±æµ…æ¥å¯è§†åŒ–ç›¸å…³ç³»æ•°ï¼š æ·±è“ï¼†ç»†é•¿ è¡¨ç¤ºå¼ºæ­£ç›¸å…³ï¼ˆæ¥è¿‘ +1ï¼‰ï¼›æ·±çº¢ï¼†æ‰å®½ è¡¨ç¤ºå¼ºè´Ÿç›¸å…³ï¼ˆæ¥è¿‘ â€“1ï¼‰ï¼›æµ…ç°/æ‰åœ† è¡¨ç¤ºæ— æˆ–å¼±ç›¸å…³ï¼ˆæ¥è¿‘ 0ï¼‰
```
order_number ä¸ user_idï¼šæ­£ç›¸å…³å¾ˆé«˜ï¼ˆå› ä¸ºæ¯ä¸ªç”¨æˆ·çš„è®¢å•åºå·ä» 1 å¼€å§‹è‡ªå¢ï¼‰ï¼Œè¿™å®Œå…¨æ˜¯æ•°æ®ç»“æ„å†³å®šçš„ã€‚
order_number ä¸ days_since_prior_orderï¼šè½»å¾®è´Ÿç›¸å…³ï¼Œè¯´æ˜ç”¨æˆ·ä¸‹å•æ¬¡æ•°è¶Šå¤šï¼Œå¹³å‡æ¯æ¬¡ä¸‹å•é—´éš”å¾€å¾€è¶ŠçŸ­ï¼ˆå¿ è¯šç”¨æˆ·å¤è´­æ›´é¢‘ç¹ï¼‰ã€‚
å…¶ä»–ç»„åˆåŒæ ·åæ˜ äº†â€œç”¨æˆ·æ´»è·ƒåº¦â€ï¼ˆé«˜ order_number â†” ä½ days_since_prior_orderï¼‰ç­‰ç›´è§‚å…³ç³»ã€‚


```{r K-Means Clustering, warning=FALSE, message=FALSE}
# ç”¨æˆ·èšç±»
cluster_df <- rfm %>% select(recency, frequency) %>% scale()
set.seed(42)
km <- kmeans(cluster_df, centers=4)
rfm$cluster <- factor(km$cluster)

rfm %>% 
  # å»æ‰å¯èƒ½çš„ NA
  filter(!is.na(recency) & !is.na(frequency) & !is.na(cluster)) %>% 
  ggplot(aes(x = frequency, y = recency, color = cluster)) +
    geom_jitter(alpha = 0.4, width = 0.2, height = 0.2, size = 1.5) +
    scale_y_reverse() +   # recency è¶Šå°è¶Šè¿‘æœŸï¼Œå€’è½¬ Y è½´æ›´ç›´è§‚
    scale_x_continuous(labels = scales::comma) +
    labs(
      title    = "Râ€“F ç”¨æˆ·èšç±»åˆ†å¸ƒ",
      subtitle = "æ¯ä¸ªç‚¹ä»£è¡¨ä¸€ä¸ªç”¨æˆ·ï¼Œé¢œè‰²è¡¨ç¤º K-means åˆ†ç¾¤",
      x        = "Frequency (æ€»è®¢å•æ•°)",
      y        = "Recency (è·ä»Šå¤©æ•°ï¼Œå€’åº)",
      color    = "Cluster"
    ) +
    theme_minimal() +
    theme(
      legend.position = "right",
      plot.subtitle   = element_text(size = 10)
    )
```





ä¹‹å‰çš„RFMæ˜¯ç”¨åˆ†ä½æ•°åˆ†ç®± (ntile) çš„æ–¹æ³•ç»˜åˆ¶ R å’Œ F ç½‘æ ¼
æŒ‰æ–°è¿‘åº¦å¯¹ç”¨æˆ·è¿›è¡Œæ’åºï¼Œå¹¶ä¸ºæ¯ä¸ªæŒ‡æ ‡å°†å…¶åˆ’åˆ†ä¸º **5 ä¸ªå¤§å°ç›¸ç­‰çš„æ¡¶**ï¼ˆåˆ†ä½æ•°ï¼‰ï¼Œç„¶åç»˜åˆ¶ R_score ä¸ F_score çš„å…³ç³»å›¾ã€‚
**ä¼˜ç‚¹ï¼š**éå¸¸é€æ˜ä¸”æ˜“äºè§£é‡Šï¼ˆâ€œæ­¤å•å…ƒæ ¼æ˜¯æœ€è¿‘å‰ 20% çš„æ•°æ®ï¼Œä¹Ÿæ˜¯æœ€å¸¸å‡ºç°çš„å‰ 20% çš„æ•°æ®â€ï¼‰ã€‚
**ç¼ºç‚¹ï¼š** 1.å³ä½¿æ•°æ®åˆ†å¸ƒä¸å¹³è¡¡ï¼Œä¹Ÿä¼šåœ¨ç¬¬ 20ã€40ã€60ã€80 ä¸ªç™¾åˆ†ä½æ•°å¤„æ–½åŠ **ä¸¥æ ¼çš„æˆªæ–­**ã€‚ 2.ä¸è€ƒè™‘è”åˆåˆ†å¸ƒçš„â€œå½¢çŠ¶â€ï¼›å•ç‹¬å¤„ç†æ¯ä¸ªè½´ã€‚

K å‡å€¼èšç±» â€” â€œåŸºäºè·ç¦»çš„ç»†åˆ†â€
å°†ä¸¤ä¸ªæŒ‡æ ‡æ ‡å‡†åŒ–ï¼ˆå‡å€¼ 0ï¼Œæ ‡å‡†å·® 1ï¼‰ï¼Œç„¶åè¿è¡Œ â€‹â€‹K å‡å€¼èšç±»å°†ç”¨æˆ·åˆ’åˆ†ä¸º **4 ä¸ªèšç±»**ï¼Œä»¥æœ€å°åŒ–äºŒç»´ R-F ç©ºé—´ä¸­çš„èšç±»å†…æ–¹å·®ã€‚
**è¾“å‡ºï¼š** å››ä¸ªç»„ï¼Œæ¯ä¸ªç»„éƒ½æœ‰å„è‡ªçš„è´¨å¿ƒï¼ˆä¾‹å¦‚â€œé«˜é¢‘/é«˜é¢‘â€ã€â€œä½é¢‘/ä¸­é¢‘â€ç­‰ï¼‰ã€‚
**ä¼˜ç‚¹ï¼š** 1.èšç±»åŸºäº**å®é™…æ•°æ®å¯†åº¦**å’Œè‡ªç„¶åˆ†ç»„ï¼Œè€Œéä»»æ„ç™¾åˆ†ä½æ•°ã€‚ 2.å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©ä»»æ„æ•°é‡çš„èšç±»ã€‚
**ç¼ºç‚¹ï¼š** 1.å¦‚æœåˆ©ç›Šç›¸å…³è€…æœŸæœ›â€œå‰ 20% = VIPâ€çš„é€»è¾‘ï¼Œåˆ™æ›´éš¾è§£é‡Šã€‚ 2.å¿…é¡»äº‹åè§£é‡Šæ¯ä¸ªèšç±»çš„å«ä¹‰ï¼ˆä¾‹å¦‚ï¼Œèšç±» 1 =â€œæ–°æ‰‹â€ï¼Œèšç±» 2 =â€œæ½œåœ¨é«˜æ¶ˆè´¹ç”¨æˆ·â€ï¼‰ã€‚

å¦‚æœè®¤ä¸ºå®¢æˆ·æ„æˆæ˜¯**è‡ªç„¶ç¾¤ä½“**ï¼ˆä¾‹å¦‚ï¼Œä¸ 20% çš„å‰Šå‡ä¸ä¸€è‡´çš„ä¸­é¢‘â€œæœ€ä½³ç‚¹â€ï¼‰ï¼Œå¹¶ä¸”å¸Œæœ›æ•°æ®èƒ½å¤Ÿé©±åŠ¨ç»†åˆ†å®šä¹‰ï¼Œé‚£ä¹ˆ**K å‡å€¼**ä¼šæ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚

æ•£ç‚¹å›¾â€œå¤ªâ€çº¿æ€§äº†ï¼Œå› ä¸º**æ–°è¿‘åº¦**è®¡ç®—æ–¹å¼æ˜¯ï¼šrecency = as.numeric(today() - max(order_number)) å®é™…ä¸Šï¼Œå®ƒçš„ä½œç”¨æ˜¯ recency_i = today() - (ç”¨æˆ· i çš„æœ€é«˜ order_number) æ‰€ä»¥ï¼Œå¦‚æœç”¨æˆ· i ä¸‹äº† 50 ä¸ªè®¢å•ï¼Œå°±æ˜¯åœ¨æ‰§è¡Œ `today() - 50`â€”â€”è®¢å•æ•°é‡å’Œâ€œæ–°è¿‘åº¦â€ä¹‹é—´å®Œç¾çš„ä¸€ä¸€å¯¹åº”å…³ç³»ï¼Œå› æ­¤æ˜¯ç›´çº¿å¯¹è§’çº¿

ä¿®å¤â€œæœ€è¿‘æˆäº¤é‡â€â†’ä½¿ç”¨è‡ªä¸Šæ¬¡è®¢å•ä»¥æ¥çš„å®é™…å¤©æ•°

```{r K-Means Clustering2, warning=FALSE, message=FALSE}
library(forcats)
# 1. Build pseudo-calendar orders_fake first (if not already in env)
base_date <- as.Date("2024-01-01")

orders_fake <- orders %>% # # ä¸ºæ¯ä¸ªè®¢å•é‡å»ºä¸€ä¸ªä¼ªæ—¥å†æ—¥æœŸ
  arrange(user_id, order_number) %>%
  group_by(user_id) %>%
  mutate(
    days       = replace_na(days_since_prior_order, 0),
    cum_days   = cumsum(days),
    order_date = base_date + cum_days
  ) %>%
  ungroup()

# 2. Compute RFM properly from orders_fake
rfm2 <- orders_fake %>%
  group_by(user_id) %>%
  summarise(
    recency   = as.numeric(today() - max(order_date)),  # è‡ªä¸Šæ¬¡å®é™… order_date ä»¥æ¥çš„å¤©æ•°
    frequency = n(),                                    # è®¢å•æ€»æ•°
    .groups   = "drop"
  )

# 3. K-means clustering
cluster_df <- rfm2 %>% select(recency, frequency) %>% scale()
set.seed(42)
km <- kmeans(cluster_df, centers = 4)
rfm2$cluster <- factor(km$cluster)

# 4. Plot the clusters in RF space
rfm2 %>%
  ggplot(aes(x = frequency, y = recency, color = cluster)) +
    geom_jitter(alpha = 0.4, size = 1.5, width = 0.2, height = 0.2) +
    scale_y_reverse() +  
    scale_x_continuous(labels = scales::comma) +
    labs(
      title    = "Râ€“F ç”¨æˆ·èšç±»åˆ†å¸ƒï¼ˆRecency = days since last orderï¼‰",
      x        = "Frequency (æ€»è®¢å•æ•°)",
      y        = "Recency (å¤©, å€’åº)",
      color    = "Cluster"
    ) +
    theme_minimal()

```

1. **`order_date` æ˜¯ä¸€ä¸ªçœŸæ­£çš„æ—¥å†æ—¥æœŸ**ï¼ˆå°½ç®¡æ˜¯ä¼ªæ—¥å†ï¼‰ï¼Œé€šè¿‡ç´¯è®¡çœŸå®çš„ `days_since_prior_order` åç§»é‡ã€‚
2. **`recency = today() - max(order_date)`** ç°åœ¨è¡¡é‡çš„æ˜¯è‡ªç”¨æˆ·ä¸Šæ¬¡ä¸‹å•ä»¥æ¥çš„å®é™…å¤©æ•°ã€‚
3. ç”±äº **é¢‘ç‡**ï¼ˆè®¢å•æ€»æ•°ï¼‰å’Œ **æ–°è¿‘åº¦**ï¼ˆè‡ªä¸Šæ¬¡ä¸‹å•ä»¥æ¥çš„å¤©æ•°ï¼‰ç°åœ¨æ˜¯ **ä¸¤ä¸ªç‹¬ç«‹çš„çœŸå®ä¸–ç•Œä¿¡å·**ï¼Œå› æ­¤å®ƒä»¬ä¹‹é—´ä¸å­˜åœ¨å¼ºåˆ¶çš„çº¿æ€§å…³ç³»ã€‚


èšç±»é¢œè‰² æ–°è¿‘åº¦ é¢‘ç‡ ä¸šåŠ¡è§£è¯»
1 ğŸ”´ çº¢è‰² é«˜ ä½ é£é™©/ä¼‘çœ 
è®¢å•æ€»æ•°å¾ˆå°‘ï¼Œå¹¶ä¸”å¾ˆé•¿æ—¶é—´æ²¡æœ‰è´­ä¹°ã€‚é€‚åˆç§¯æåœ°è¿›è¡ŒæŒ½å›è¥é”€æ´»åŠ¨ã€‚
2 ğŸŸ¢ ç»¿è‰² ä½ é«˜ å† å†›
ä¸‹å•é¢‘ç‡å¾ˆé«˜ï¼Œå¹¶ä¸”åˆšåˆšè´­ä¹°â€”â€”æ‚¨æœ€å¿ è¯šã€ä»·å€¼æœ€é«˜çš„å®¢æˆ·ã€‚é‡ç‚¹å…³æ³¨ VIP æƒç›Šã€‚
3 ğŸ”µ è“ç»¿è‰² ä¸­ ä½-ä¸­ æ½œåŠ›
ä¸‹å•é¢‘ç‡é€‚ä¸­ï¼Œå¹¶ä¸”è·ç¦»ä¸Šæ¬¡ä¸‹å•æ—¶é—´ä¸é•¿ã€‚å¯ä»¥é€šè¿‡æœ‰é’ˆå¯¹æ€§çš„ä¼˜æƒ æ´»åŠ¨å°†å…¶è½¬åŒ–ä¸ºå¸¸å®¢ã€‚
4 ğŸŸ£ ç´«è‰² ä½-ä¸­ ä¸­-é«˜ å¿ è¯šä½†è€åŒ–
ä¸‹å•é¢‘ç‡ä¸é”™ï¼Œä½†å¾ˆä¹…æ²¡æœ‰ä¸‹å•äº†ã€‚ä»–ä»¬æ­£åœ¨æµå¤±â€”â€”æé†’é‚®ä»¶æˆ–æ–°çš„æ¿€åŠ±æªæ–½å¯ä»¥é‡æ–°æ¿€æ´»ä»–ä»¬ã€‚
